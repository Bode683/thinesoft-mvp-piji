server default {

    listen {
        type = auth
        ipaddr = *
        port = 1812
    }

    listen {
        type = acct
        ipaddr = *
        port = 1813
    }

    debug {
        auth = yes
        accounting = yes
        module_failure = yes
        module_success = yes
    }

    # Section authorize : vérification initiale des identifiants
    authorize {
        filter_username
        preprocess
        rest {
            ok = return
            updated = return
            fail = 1
            reject = 1
            noop = 1
        }
        
        if (fail || reject || noop) {
            sql
            if (ok || updated) {
                update control {
                    Auth-Type := PAP
                }
            }
        }
        else {
            update control {
                Auth-Type := REST
            }
        }
        
        pap
    }

    authenticate {
        Auth-Type PAP {
            pap
        }

        Auth-Type REST {
            rest
        }
    }

    preacct {
        preprocess
    }

    accounting {
        rest
        detail
        
        sql {
            ok = 1
            fail = 1
        }
        
        rest {
            ok = 1
            fail = 1
            reject = 1
        }
        
        # Logging des erreurs d'accounting (simplifié)
        if (fail) {
            linelog
        }
    }

    # Section session : gestion des sessions
    session {
        sql
    }

    # Section post-auth : traitements post-authentification
    post-auth {
        sql
        rest

        exec {
            wait = yes
            program = "/bin/echo '%{User-Name}: %{reply:Packet-Type}' >> /var/log/freeradius/auth_results.log"
        }
        if (session-state:User-Name) {
            update reply {
                Reply-Message := "Bonjour %{session-state:User-Name}, votre authentification a %{reply:Packet-Type}"
            }
        }
        else {
            update reply {
                Reply-Message := "Authentification %{reply:Packet-Type}"
            }
        }
    }
}
