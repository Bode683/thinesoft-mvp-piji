server default {

    listen {
        type = auth
        ipaddr = *
        port = 1812
    }

    listen {
        type = acct
        ipaddr = *
        port = 1813
    }

    debug {
        auth = yes
        accounting = yes
        module_failure = yes
        module_success = yes
    }

    # Section authorize : vérification initiale des identifiants
    authorize {
        preprocess
        # Always try REST first
        rest
        # If REST is successful, we set the Auth-Type to REST and stop processing authorize
        if (ok || updated) {
            update control {
                Auth-Type := REST
            }
            # We are done, no need to check sql or files
            return
        }

        # If REST fails, we fall back to other methods
        sql
        if (ok || updated) {
            update control {
                Auth-Type := PAP
            }
        }
        pap
    }

    authenticate {
        Auth-Type PAP {
            pap
        }

        Auth-Type REST {
            rest
        }
    }

    preacct {
        preprocess
    }

    accounting {
        rest
        detail
        
        sql {
            ok = 1
            fail = 1
        }
        
        rest {
            ok = 1
            fail = 1
            reject = 1
        }
        
        # Logging des erreurs d'accounting (simplifié)
        if (fail) {
            linelog
        }
    }

    # Section session : gestion des sessions
    session {
        sql
    }

    # Section post-auth : traitements post-authentification
    post-auth {
        sql
        rest
        
        # Logging simplifié
        linelog
        if (session-state:User-Name) {
            update reply {
                Reply-Message := "Bonjour %{session-state:User-Name}, votre authentification a %{reply:Packet-Type}"
            }
        }
        else {
            update reply {
                Reply-Message := "Authentification %{reply:Packet-Type}"
            }
        }
    }
}