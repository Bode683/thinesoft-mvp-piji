# Mode host network - les conteneurs utilisent directement le réseau de l'hôte
# Cela permet l'intégration avec l'EAP 110 sur le même réseau

services:
  freeradius:
    build: ./freeradius
    network_mode: host
    depends_on:
      postgres:
        condition: service_healthy
    cap_add:
      - NET_ADMIN

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    network_mode: host
    depends_on:
      - postgres
      - freeradius
    volumes:
      - logs_volume:/app/logs
      - ./backend/.env:/app/.env
    environment:
      - RADIUS_SERVER=127.0.0.1
      - RADIUS_SECRET=testing123
      - DATABASE_URL=postgresql://radius:radiuspass@127.0.0.1:5432/radius
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      - SECRET_KEY=your-secret-key-here
      - ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=30

  postgres:
    image: postgres:15  # Version spécifique recommandée
    network_mode: host
    environment:
      POSTGRES_DB: radius
      POSTGRES_USER: radius
      POSTGRES_PASSWORD: radiuspass
      POSTGRES_HOST_AUTH_METHOD: md5
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./sql/schema.sql:/docker-entrypoint-initdb.d/init.sql
      - ./postgresql/postgresql.conf:/etc/postgresql/postgresql.conf
      - ./postgresql/pg_hba.conf:/etc/postgresql/pg_hba.conf
    command: ["-c", "config_file=/etc/postgresql/postgresql.conf"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U radius -d radius"]
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  pgadmin:
    image: dpage/pgadmin4
    network_mode: host
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@radius.com
      PGADMIN_DEFAULT_PASSWORD: admin123
      PGADMIN_LISTEN_PORT: 8084
    depends_on:
      - postgres
    restart: unless-stopped

  captive-portal:
    build:
      context: ./captive-portal
      dockerfile: Dockerfile
    network_mode: host
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000/api/v1
    depends_on:
      - backend
    restart: unless-stopped

volumes:
  postgres-data:
  logs_volume:
