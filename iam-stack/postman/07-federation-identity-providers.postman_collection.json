{
  "info": {
    "name": "07 - Federation & Identity Providers",
    "description": "User federation and identity provider management",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "auth": {
    "type": "bearer",
    "bearer": [
      {
        "key": "token",
        "value": "{{access_token}}",
        "type": "string"
      }
    ]
  },
  "item": [
    {
      "name": "User Storage (LDAP)",
      "item": [
        {
          "name": "List User Storage Providers",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    var jsonData = pm.response.json();",
                  "    pm.test('Status code is 200', function () {",
                  "        pm.response.to.have.status(200);",
                  "    });",
                  "    pm.test('Providers array exists', function () {",
                  "        pm.expect(jsonData).to.be.an('array');",
                  "    });",
                  "    if (jsonData.length > 0) {",
                  "        pm.environment.set('ldap_provider_id', jsonData[0].id);",
                  "    }",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{admin_api_base}}/components?type=org.keycloak.storage.UserStorageProvider",
              "host": ["{{admin_api_base}}"],
              "path": ["components"],
              "query": [
                {
                  "key": "type",
                  "value": "org.keycloak.storage.UserStorageProvider"
                }
              ]
            },
            "description": "Get all user storage providers (LDAP, Active Directory, etc.)."
          },
          "response": []
        },
        {
          "name": "Get LDAP Provider by ID",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    var jsonData = pm.response.json();",
                  "    pm.test('Status code is 200', function () {",
                  "        pm.response.to.have.status(200);",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{admin_api_base}}/components/{{ldap_provider_id}}",
              "host": ["{{admin_api_base}}"],
              "path": ["components", "{{ldap_provider_id}}"]
            },
            "description": "Get LDAP provider configuration by ID."
          },
          "response": []
        },
        {
          "name": "Create LDAP Provider - OpenLDAP",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 201) {",
                  "    pm.test('Status code is 201', function () {",
                  "        pm.response.to.have.status(201);",
                  "    });",
                  "    var location = pm.response.headers.get('Location');",
                  "    if (location) {",
                  "        var providerId = location.split('/').pop();",
                  "        pm.environment.set('ldap_provider_id', providerId);",
                  "        console.log('Created LDAP provider ID: ' + providerId);",
                  "    }",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"openldap-federation\",\n  \"providerId\": \"ldap\",\n  \"providerType\": \"org.keycloak.storage.UserStorageProvider\",\n  \"config\": {\n    \"enabled\": [\"true\"],\n    \"priority\": [\"0\"],\n    \"fullSyncPeriod\": [\"-1\"],\n    \"changedSyncPeriod\": [\"-1\"],\n    \"cachePolicy\": [\"DEFAULT\"],\n    \"evictionDay\": [],\n    \"evictionHour\": [],\n    \"evictionMinute\": [],\n    \"maxLifespan\": [],\n    \"batchSizeForSync\": [\"1000\"],\n    \"editMode\": [\"READ_ONLY\"],\n    \"syncRegistrations\": [\"false\"],\n    \"vendor\": [\"other\"],\n    \"usernameLDAPAttribute\": [\"uid\"],\n    \"rdnLDAPAttribute\": [\"uid\"],\n    \"uuidLDAPAttribute\": [\"entryUUID\"],\n    \"userObjectClasses\": [\"inetOrgPerson, organizationalPerson\"],\n    \"connectionUrl\": [\"ldap://openldap:389\"],\n    \"usersDn\": [\"ou=People,dc=theddt,dc=local\"],\n    \"authType\": [\"simple\"],\n    \"bindDn\": [\"cn=admin,dc=theddt,dc=local\"],\n    \"bindCredential\": [\"admin123\"],\n    \"searchScope\": [\"1\"],\n    \"useTruststoreSpi\": [\"ldapsOnly\"],\n    \"connectionPooling\": [\"true\"],\n    \"pagination\": [\"true\"],\n    \"allowKerberosAuthentication\": [\"false\"],\n    \"debug\": [\"false\"],\n    \"useKerberosForPasswordAuthentication\": [\"false\"]\n  }\n}"
            },
            "url": {
              "raw": "{{admin_api_base}}/components",
              "host": ["{{admin_api_base}}"],
              "path": ["components"]
            },
            "description": "Create OpenLDAP user federation provider."
          },
          "response": []
        },
        {
          "name": "Update LDAP Provider",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 204', function () {",
                  "    pm.response.to.have.status(204);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"id\": \"{{ldap_provider_id}}\",\n  \"name\": \"openldap-federation\",\n  \"providerId\": \"ldap\",\n  \"providerType\": \"org.keycloak.storage.UserStorageProvider\",\n  \"config\": {\n    \"enabled\": [\"true\"],\n    \"editMode\": [\"WRITABLE\"],\n    \"syncRegistrations\": [\"true\"]\n  }\n}"
            },
            "url": {
              "raw": "{{admin_api_base}}/components/{{ldap_provider_id}}",
              "host": ["{{admin_api_base}}"],
              "path": ["components", "{{ldap_provider_id}}"]
            },
            "description": "Update LDAP provider configuration."
          },
          "response": []
        },
        {
          "name": "Delete LDAP Provider",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 204', function () {",
                  "    pm.response.to.have.status(204);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "DELETE",
            "header": [],
            "url": {
              "raw": "{{admin_api_base}}/components/{{ldap_provider_id}}",
              "host": ["{{admin_api_base}}"],
              "path": ["components", "{{ldap_provider_id}}"]
            },
            "description": "Delete LDAP provider."
          },
          "response": []
        },
        {
          "name": "Test LDAP Connection",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 204) {",
                  "    pm.test('LDAP connection successful', function () {",
                  "        pm.response.to.have.status(204);",
                  "    });",
                  "} else {",
                  "    pm.test('LDAP connection failed', function () {",
                  "        pm.response.to.have.status(204);",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"action\": \"testConnection\",\n  \"connectionUrl\": \"ldap://openldap:389\",\n  \"bindDn\": \"cn=admin,dc=theddt,dc=local\",\n  \"bindCredential\": \"admin123\"\n}"
            },
            "url": {
              "raw": "{{admin_api_base}}/testLDAPConnection",
              "host": ["{{admin_api_base}}"],
              "path": ["testLDAPConnection"]
            },
            "description": "Test LDAP connection before creating provider."
          },
          "response": []
        },
        {
          "name": "Test LDAP Authentication",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 204) {",
                  "    pm.test('LDAP authentication successful', function () {",
                  "        pm.response.to.have.status(204);",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"action\": \"testAuthentication\",\n  \"connectionUrl\": \"ldap://openldap:389\",\n  \"bindDn\": \"cn=admin,dc=theddt,dc=local\",\n  \"bindCredential\": \"admin123\"\n}"
            },
            "url": {
              "raw": "{{admin_api_base}}/testLDAPConnection",
              "host": ["{{admin_api_base}}"],
              "path": ["testLDAPConnection"]
            },
            "description": "Test LDAP authentication."
          },
          "response": []
        },
        {
          "name": "Sync LDAP Users - Full",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    var jsonData = pm.response.json();",
                  "    pm.test('Status code is 200', function () {",
                  "        pm.response.to.have.status(200);",
                  "    });",
                  "    pm.test('Sync result exists', function () {",
                  "        pm.expect(jsonData.status).to.exist;",
                  "    });",
                  "    console.log('Sync status: ' + jsonData.status);",
                  "    if (jsonData.added) console.log('Users added: ' + jsonData.added);",
                  "    if (jsonData.updated) console.log('Users updated: ' + jsonData.updated);",
                  "    if (jsonData.removed) console.log('Users removed: ' + jsonData.removed);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [],
            "url": {
              "raw": "{{admin_api_base}}/user-storage/{{ldap_provider_id}}/sync?action=triggerFullSync",
              "host": ["{{admin_api_base}}"],
              "path": ["user-storage", "{{ldap_provider_id}}", "sync"],
              "query": [
                {
                  "key": "action",
                  "value": "triggerFullSync"
                }
              ]
            },
            "description": "Trigger full synchronization of LDAP users."
          },
          "response": []
        },
        {
          "name": "Sync LDAP Users - Changed Only",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    var jsonData = pm.response.json();",
                  "    pm.test('Status code is 200', function () {",
                  "        pm.response.to.have.status(200);",
                  "    });",
                  "    console.log('Sync status: ' + jsonData.status);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [],
            "url": {
              "raw": "{{admin_api_base}}/user-storage/{{ldap_provider_id}}/sync?action=triggerChangedUsersSync",
              "host": ["{{admin_api_base}}"],
              "path": ["user-storage", "{{ldap_provider_id}}", "sync"],
              "query": [
                {
                  "key": "action",
                  "value": "triggerChangedUsersSync"
                }
              ]
            },
            "description": "Trigger synchronization of changed LDAP users only."
          },
          "response": []
        },
        {
          "name": "Remove Imported LDAP Users",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200 or 204', function () {",
                  "    pm.expect(pm.response.code).to.be.oneOf([200, 204]);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [],
            "url": {
              "raw": "{{admin_api_base}}/user-storage/{{ldap_provider_id}}/remove-imported-users",
              "host": ["{{admin_api_base}}"],
              "path": ["user-storage", "{{ldap_provider_id}}", "remove-imported-users"]
            },
            "description": "Remove all users imported from this LDAP provider."
          },
          "response": []
        },
        {
          "name": "Unlink LDAP Users",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200 or 204', function () {",
                  "    pm.expect(pm.response.code).to.be.oneOf([200, 204]);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [],
            "url": {
              "raw": "{{admin_api_base}}/user-storage/{{ldap_provider_id}}/unlink-users",
              "host": ["{{admin_api_base}}"],
              "path": ["user-storage", "{{ldap_provider_id}}", "unlink-users"]
            },
            "description": "Unlink all users from this LDAP provider (keeps users in Keycloak)."
          },
          "response": []
        },
        {
          "name": "Create LDAP Mapper - Username",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 201) {",
                  "    pm.test('Status code is 201', function () {",
                  "        pm.response.to.have.status(201);",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"username\",\n  \"providerId\": \"user-attribute-ldap-mapper\",\n  \"providerType\": \"org.keycloak.storage.ldap.mappers.LDAPStorageMapper\",\n  \"parentId\": \"{{ldap_provider_id}}\",\n  \"config\": {\n    \"ldap.attribute\": [\"uid\"],\n    \"is.mandatory.in.ldap\": [\"true\"],\n    \"read.only\": [\"true\"],\n    \"always.read.value.from.ldap\": [\"false\"],\n    \"user.model.attribute\": [\"username\"]\n  }\n}"
            },
            "url": {
              "raw": "{{admin_api_base}}/components",
              "host": ["{{admin_api_base}}"],
              "path": ["components"]
            },
            "description": "Create LDAP attribute mapper for username."
          },
          "response": []
        },
        {
          "name": "Get LDAP Mappers",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    var jsonData = pm.response.json();",
                  "    pm.test('Status code is 200', function () {",
                  "        pm.response.to.have.status(200);",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{admin_api_base}}/components?parent={{ldap_provider_id}}&type=org.keycloak.storage.ldap.mappers.LDAPStorageMapper",
              "host": ["{{admin_api_base}}"],
              "path": ["components"],
              "query": [
                {
                  "key": "parent",
                  "value": "{{ldap_provider_id}}"
                },
                {
                  "key": "type",
                  "value": "org.keycloak.storage.ldap.mappers.LDAPStorageMapper"
                }
              ]
            },
            "description": "Get all LDAP mappers for the provider."
          },
          "response": []
        }
      ]
    },
    {
      "name": "Identity Providers",
      "item": [
        {
          "name": "List Identity Providers",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    var jsonData = pm.response.json();",
                  "    pm.test('Status code is 200', function () {",
                  "        pm.response.to.have.status(200);",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{admin_api_base}}/identity-provider/instances",
              "host": ["{{admin_api_base}}"],
              "path": ["identity-provider", "instances"]
            },
            "description": "Get all identity providers configured in the realm."
          },
          "response": []
        },
        {
          "name": "Get Identity Provider by Alias",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    var jsonData = pm.response.json();",
                  "    pm.test('Status code is 200', function () {",
                  "        pm.response.to.have.status(200);",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{admin_api_base}}/identity-provider/instances/google",
              "host": ["{{admin_api_base}}"],
              "path": ["identity-provider", "instances", "google"]
            },
            "description": "Get identity provider by alias."
          },
          "response": []
        },
        {
          "name": "Create Identity Provider - Google",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 201) {",
                  "    pm.test('Status code is 201', function () {",
                  "        pm.response.to.have.status(201);",
                  "    });",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"alias\": \"google\",\n  \"displayName\": \"Google\",\n  \"providerId\": \"google\",\n  \"enabled\": true,\n  \"trustEmail\": true,\n  \"storeToken\": false,\n  \"addReadTokenRoleOnCreate\": false,\n  \"authenticateByDefault\": false,\n  \"linkOnly\": false,\n  \"firstBrokerLoginFlowAlias\": \"first broker login\",\n  \"config\": {\n    \"clientId\": \"your-google-client-id\",\n    \"clientSecret\": \"your-google-client-secret\",\n    \"defaultScope\": \"openid profile email\",\n    \"hostedDomain\": \"\"\n  }\n}"
            },
            "url": {
              "raw": "{{admin_api_base}}/identity-provider/instances",
              "host": ["{{admin_api_base}}"],
              "path": ["identity-provider", "instances"]
            },
            "description": "Create Google identity provider (requires Google OAuth credentials)."
          },
          "response": []
        },
        {
          "name": "Update Identity Provider",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 204', function () {",
                  "    pm.response.to.have.status(204);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "PUT",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"alias\": \"google\",\n  \"displayName\": \"Google - Updated\",\n  \"enabled\": true,\n  \"trustEmail\": true\n}"
            },
            "url": {
              "raw": "{{admin_api_base}}/identity-provider/instances/google",
              "host": ["{{admin_api_base}}"],
              "path": ["identity-provider", "instances", "google"]
            },
            "description": "Update identity provider configuration."
          },
          "response": []
        },
        {
          "name": "Delete Identity Provider",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 204', function () {",
                  "    pm.response.to.have.status(204);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "DELETE",
            "header": [],
            "url": {
              "raw": "{{admin_api_base}}/identity-provider/instances/google",
              "host": ["{{admin_api_base}}"],
              "path": ["identity-provider", "instances", "google"]
            },
            "description": "Delete an identity provider."
          },
          "response": []
        }
      ]
    }
  ]
}
