server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /positions/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # Docker container logs via Docker socket
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      # Extract container name without leading slash
      - source_labels: ['__meta_docker_container_name']
        target_label: container
        regex: '/(.*)'
        replacement: '$1'
      # Extract compose service name
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        target_label: service
      # Extract compose project name
      - source_labels: ['__meta_docker_container_label_com_docker_compose_project']
        target_label: project
      # Keep container ID for debugging
      - source_labels: ['__meta_docker_container_id']
        target_label: container_id
    pipeline_stages:
      - docker: {}
      # Try to parse JSON logs
      - match:
          selector: '{container=~".+"}'
          stages:
            - json:
                expressions:
                  level: level
                  msg: msg
                  message: message
                  time: time
                  timestamp: timestamp
            - labels:
                level:

  # Traefik access logs (JSON format)
  - job_name: traefik-access
    static_configs:
      - targets:
          - localhost
        labels:
          job: traefik-access
          __path__: /var/log/traefik/access.log
    pipeline_stages:
      - json:
          expressions:
            status: StatusCode
            method: RequestMethod
            host: RequestHost
            path: RequestPath
            duration: Duration
            client: ClientAddr
            service: ServiceName
            router: RouterName
      - labels:
          status:
          method:
          host:
          service:
      # Add log level based on status code
      - template:
          source: level
          template: '{{ if ge (int .status) 500 }}error{{ else if ge (int .status) 400 }}warn{{ else }}info{{ end }}'
      - labels:
          level:

  # PostgreSQL logs (filtered for pgAudit)
  - job_name: postgres
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: name
            values: ["pesequel-postgres"]
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        target_label: container
        regex: '/(.*)'
        replacement: '$1'
      - target_label: job
        replacement: postgres
    pipeline_stages:
      - docker: {}
      # Detect pgAudit log lines
      - match:
          selector: '{job="postgres"}'
          stages:
            - regex:
                expression: '.*AUDIT:(?P<audit_type>[^,]+),(?P<statement_id>[^,]+),(?P<substatement_id>[^,]+),(?P<class>[^,]+),(?P<command>[^,]+),(?P<object_type>[^,]*),(?P<object_name>[^,]*),(?P<statement>.*)$'
            - labels:
                audit_type:
                class:
                command:

  # Keycloak logs
  - job_name: keycloak
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: name
            values: ["quewall-keycloak"]
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        target_label: container
        regex: '/(.*)'
        replacement: '$1'
      - target_label: job
        replacement: keycloak
    pipeline_stages:
      - docker: {}
      # Parse Keycloak log format
      - regex:
          expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2},\d{3})\s+(?P<level>\w+)\s+\[(?P<logger>[^\]]+)\]\s+\((?P<thread>[^\)]+)\)\s+(?P<message>.*)$'
      - labels:
          level:
          logger:

  # Django CMS logs
  - job_name: djangocms
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: name
            values: ["djangocms-app"]
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        target_label: container
        regex: '/(.*)'
        replacement: '$1'
      - target_label: job
        replacement: djangocms
    pipeline_stages:
      - docker: {}
      # Try to parse JSON logs from Django
      - match:
          selector: '{job="djangocms"}'
          stages:
            - json:
                expressions:
                  level: levelname
                  message: message
                  logger: name
                  pathname: pathname
            - labels:
                level:
                logger:

  # CrowdSec logs
  - job_name: crowdsec
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: name
            values: ["koolflows-crowdsec"]
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        target_label: container
        regex: '/(.*)'
        replacement: '$1'
      - target_label: job
        replacement: crowdsec
    pipeline_stages:
      - docker: {}
      # Parse CrowdSec JSON logs
      - match:
          selector: '{job="crowdsec"}'
          stages:
            - json:
                expressions:
                  level: level
                  msg: msg
                  type: type
            - labels:
                level:
                type:
