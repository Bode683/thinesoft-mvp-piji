networks:
  web:
    external: true

volumes:
  postgres_data:
    driver: local
  pgadmin_data:
    driver: local
  crowdsec_data:
    driver: local
  traefik_logs:
    driver: local
  keycloak_data:
    driver: local
  djangocms_media:
    driver: local
  djangocms_static:
    driver: local

secrets:
  postgres_password:
    file: ./secrets/postgres_password.txt
  postgres_user:
    file: ./secrets/postgres_user.txt
  postgres_db:
    file: ./secrets/postgres_db.txt
  pgadmin_email:
    file: ./secrets/pgadmin_email.txt
  pgadmin_password:
    file: ./secrets/pgadmin_password.txt
  authenticator_password:
    file: ./secrets/authenticator_password.txt
  crowdsec_bouncer_key:
    file: ./secrets/crowdsec_bouncer_key.txt
  keycloak_admin_password:
    file: ./secrets/keycloak_admin_password.txt
  keycloak_db_password:
    file: ./secrets/keycloak_db_password.txt
  oauth2_client_secret:
    file: ./secrets/oauth2_client_secret.txt
  oauth2_cookie_secret:
    file: ./secrets/oauth2_cookie_secret.txt
  djangocms_db_password:
    file: ./secrets/djangocms_db_password.txt
  django_secret_key:
    file: ./secrets/django_secret_key.txt
  django_superuser_password:
    file: ./secrets/django_superuser_password.txt
  djangocms_keycloak_client_secret:
    file: ./secrets/djangocms_keycloak_client_secret.txt

services:
  ###########################################
  # KoolFlows Microservice - Traefik + CrowdSec
  ###########################################

  traefik:
    image: traefik:v3.6
    container_name: koolflows-traefik
    restart: unless-stopped
    networks:
      - web
    ports:
      - "80:80"
      - "8888:8080"  # Dashboard (mapped to 8888 to avoid conflict with CrowdSec)
      - "443:443"    # HTTPS (for future use)
    environment:
      - CROWDSEC_BOUNCER_KEY=${CROWDSEC_BOUNCER_KEY:-placeholder}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./KoolFlows/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./KoolFlows/traefik/dynamic:/etc/traefik/dynamic:ro
      - ./KoolFlows/traefik/plugins-local:/plugins-local:ro
      - traefik_logs:/var/log/traefik
    depends_on:
      crowdsec:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.theddt.local`)"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      - "traefik.http.routers.traefik-dashboard.entrypoints=web"
      - "traefik.http.routers.traefik-dashboard.middlewares=crowdsec-bouncer@file"

  crowdsec:
    build:
      context: ./KoolFlows/crowdsec
      dockerfile: Dockerfile
    container_name: koolflows-crowdsec
    restart: unless-stopped
    networks:
      - web
    ports:
      - "127.0.0.1:8080:8080"
      - "127.0.0.1:7422:7422"
    expose:
      - 8080
      - 6060
      - 7422
    environment:
      - DISABLE_ONLINE_API=true
    secrets:
      - crowdsec_bouncer_key
    volumes:
      - crowdsec_data:/var/lib/crowdsec/data
      - ./KoolFlows/crowdsec/config/acquis.yaml:/etc/crowdsec/acquis.yaml:ro
      - ./KoolFlows/crowdsec/config/profiles.yaml:/etc/crowdsec/profiles.yaml:ro
      - traefik_logs:/var/log/traefik:ro
    healthcheck:
      test: ["CMD", "cscli", "version"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 30s

  ###########################################
  # PeSquel Microservice - Database Services
  ###########################################

  postgres:
    build:
      context: ./PeSquel/postgres
      dockerfile: Dockerfile
    container_name: pesequel-postgres
    restart: unless-stopped
    networks:
      - web
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER_FILE: /run/secrets/postgres_user
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      POSTGRES_DB_FILE: /run/secrets/postgres_db
      PGDATA: /var/lib/postgresql/data/pgdata
      PGSSLMODE: disable
    secrets:
      - postgres_user
      - postgres_password
      - postgres_db
      - authenticator_password
      - keycloak_db_password
      - djangocms_db_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$(cat /run/secrets/postgres_user) -d $$(cat /run/secrets/postgres_db)"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  pgbouncer:
    build:
      context: ./PeSquel/pgbouncer
      dockerfile: Dockerfile
    container_name: pesequel-pgbouncer
    restart: unless-stopped
    networks:
      - web
    environment:
      - PGBOUNCER_DATABASES=keycloak,django_db
      - PGBOUNCER_HOST=postgres
      - PGBOUNCER_PORT=5432
      - PGBOUNCER_AUTH_USER=authenticator
    ports:
      - "6432:6432"
    secrets:
      - postgres_user
      - postgres_password
      - postgres_db
      - authenticator_password
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pgrep -x pgbouncer || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  pgadmin:
    image: dpage/pgadmin4:9.10
    container_name: pesequel-pgadmin
    restart: unless-stopped
    networks:
      - web
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@theddt.com
      PGADMIN_DEFAULT_PASSWORD_FILE: /run/secrets/pgadmin_password
      PGADMIN_CONFIG_SERVER_MODE: "True"
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: "False"
    secrets:
      - pgadmin_password
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      postgres:
        condition: service_healthy
      traefik:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/misc/ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pgadmin.rule=Host(`pgadmin.theddt.local`)"
      - "traefik.http.routers.pgadmin.entrypoints=web"
      - "traefik.http.routers.pgadmin.middlewares=crowdsec-full@file"
      - "traefik.http.services.pgadmin.loadbalancer.server.port=80"

  ###########################################
  # QueWall Microservice - Authentication Services
  ###########################################

  keycloak:
    build:
      context: ./QueWall/keycloak
      dockerfile: Dockerfile
    container_name: quewall-keycloak
    restart: unless-stopped
    networks:
      - web
    command: start-dev --import-realm
    environment:
      # Database configuration
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: keycloak

      # Admin credentials
      KEYCLOAK_ADMIN: admin

      # Server configuration
      KC_HTTP_ENABLED: "true"
      KC_HOSTNAME_STRICT: "false"
      KC_PROXY: edge
      KC_METRICS_ENABLED: "false"
      KC_HEALTH_ENABLED: "true"
    secrets:
      - keycloak_admin_password
      - keycloak_db_password
    volumes:
      - ./QueWall/keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
      - keycloak_data:/opt/keycloak/data 
    depends_on:
      postgres:
        condition: service_healthy
      traefik:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/9000 && echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && cat <&3 | grep -q '200 OK'"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 90s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.keycloak.rule=Host(`keycloak.theddt.local`)"
      - "traefik.http.routers.keycloak.entrypoints=web"
      - "traefik.http.routers.keycloak.middlewares=crowdsec-full@file"
      - "traefik.http.services.keycloak.loadbalancer.server.port=8080"

  oauth2-proxy:
    build:
      context: ./QueWall/oauth2-proxy
      dockerfile: Dockerfile
    container_name: quewall-oauth2-proxy
    restart: unless-stopped
    networks:
      - web
    environment:
      # OIDC Provider Configuration
      OAUTH2_PROXY_PROVIDER: oidc
      OAUTH2_PROXY_OIDC_ISSUER_URL: http://keycloak:8080/realms/theddt
      OAUTH2_PROXY_CLIENT_ID: oauth2-proxy-client
      OAUTH2_PROXY_REDIRECT_URL: http://auth.theddt.local/oauth2/callback
      OAUTH2_PROXY_SCOPE: "openid profile email"
      OAUTH2_PROXY_SKIP_OIDC_DISCOVERY: "false"
      OAUTH2_PROXY_INSECURE_OIDC_SKIP_ISSUER_VERIFICATION: "true"

      # Cookie Configuration
      OAUTH2_PROXY_COOKIE_DOMAINS: .theddt.local
      OAUTH2_PROXY_COOKIE_SECURE: "false"
      OAUTH2_PROXY_COOKIE_NAME: _oauth2_proxy

      # Server Configuration
      OAUTH2_PROXY_HTTP_ADDRESS: 0.0.0.0:4180
      OAUTH2_PROXY_REVERSE_PROXY: "true"
      OAUTH2_PROXY_PASS_ACCESS_TOKEN: "true"
      OAUTH2_PROXY_PASS_USER_HEADERS: "true"
      OAUTH2_PROXY_SET_XAUTHREQUEST: "true"

      # Email and Groups
      OAUTH2_PROXY_EMAIL_DOMAINS: "*"
      OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: "false"

      # Upstream (not used for ForwardAuth, but required)
      OAUTH2_PROXY_UPSTREAMS: static://202
    secrets:
      - oauth2_client_secret
      - oauth2_cookie_secret
    depends_on:
      keycloak:
        condition: service_healthy
      traefik:
        condition: service_started
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.oauth2-proxy.rule=Host(`auth.theddt.local`)"
      - "traefik.http.routers.oauth2-proxy.entrypoints=web"
      - "traefik.http.routers.oauth2-proxy.middlewares=crowdsec-full@file"
      - "traefik.http.services.oauth2-proxy.loadbalancer.server.port=4180"

  ###########################################
  # Django CMS Backend Application
  ###########################################

  djangocms:
    build:
      context: ./djangocms
      dockerfile: Dockerfile
    container_name: djangocms-app
    restart: unless-stopped
    networks:
      - web
    environment:
      # Application Mode
      DJANGO_ENV: production
      DATABASE: postgres

      # Database Connection (mapping to settings.py SQL_* variables)
      SQL_ENGINE: django.db.backends.postgresql
      SQL_DATABASE: django_db
      SQL_USER: djangocms
      SQL_HOST: postgres
      SQL_PORT: 5432
      # SQL_PASSWORD loaded from secret in entrypoint

      # Django Configuration
      # SECRET_KEY loaded from secret in entrypoint
      DEBUG: "False"
      DOMAIN: api.theddt.local
      SECURE_SSL_REDIRECT: "False"

      # Superuser Configuration
      DJANGO_SUPERUSER_USERNAME: admin
      DJANGO_SUPERUSER_EMAIL: admin@theddt.com
      # DJANGO_SUPERUSER_PASSWORD loaded from secret in entrypoint

      # Storage
      DEFAULT_STORAGE_DSN: file:///data/media/?url=%2Fmedia%2F

      # Payment Gateway (localstripe for testing)
      USE_LOCALSTRIPE: "True"
      STRIPE_API_KEY: sk_test_123
      STRIPE_WEBHOOK_SECRET: whsec_123
      PAYMENT_HOST: api.theddt.local
      PAYMENT_USES_SSL: "False"

      # Celery/Redis (optional, can add later)
      # REDIS_URL: redis://localhost:6379/0

      # Keycloak Configuration
      KEYCLOAK_SERVER_URL: http://keycloak:8080
      KEYCLOAK_REALM: theddt
      KEYCLOAK_CLIENT_ID: djangocms-client
      # KEYCLOAK_CLIENT_SECRET loaded from secret in entrypoint

    secrets:
      - djangocms_db_password
      - django_secret_key
      - django_superuser_password
      - djangocms_keycloak_client_secret

    volumes:
      - djangocms_media:/data/media
      - djangocms_static:/app/staticfiles

    depends_on:
      postgres:
        condition: service_healthy
      traefik:
        condition: service_started

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8000/admin/login/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    labels:
      - "traefik.enable=true"

      # API Routes (JWT only, no OAuth2-Proxy)
      - "traefik.http.routers.djangocms-api.rule=Host(`api.theddt.local`) && PathPrefix(`/api/`)"
      - "traefik.http.routers.djangocms-api.entrypoints=web"
      - "traefik.http.routers.djangocms-api.middlewares=crowdsec-full@file"
      - "traefik.http.routers.djangocms-api.service=djangocms"

      # Admin Routes (with OAuth2-Proxy)
      - "traefik.http.routers.djangocms-admin.rule=Host(`api.theddt.local`) && PathPrefix(`/admin/`)"
      - "traefik.http.routers.djangocms-admin.entrypoints=web"
      - "traefik.http.routers.djangocms-admin.middlewares=djangocms-dashboard-auth@file"
      - "traefik.http.routers.djangocms-admin.service=djangocms"
      - "traefik.http.routers.djangocms-admin.priority=20"

      # CMS Routes (with OAuth2-Proxy) - catch-all for everything except /api/ and /admin/
      - "traefik.http.routers.djangocms-cms.rule=Host(`api.theddt.local`)"
      - "traefik.http.routers.djangocms-cms.entrypoints=web"
      - "traefik.http.routers.djangocms-cms.middlewares=djangocms-dashboard-auth@file"
      - "traefik.http.routers.djangocms-cms.service=djangocms"
      - "traefik.http.routers.djangocms-cms.priority=10"

      # Service definition (shared by all routers)
      - "traefik.http.services.djangocms.loadbalancer.server.port=8000"
