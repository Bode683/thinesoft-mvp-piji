networks:
  web:
    external: true

volumes:
  postgres_data:
    driver: local
  pgadmin_data:
    driver: local
  crowdsec_data:
    driver: local
  traefik_logs:
    driver: local
  keycloak_data:
    driver: local
  djangocms_media:
    driver: local
  djangocms_static:
    driver: local
  # OmniScope volumes
  grafana_data:
    driver: local
  prometheus_data:
    driver: local
  loki_data:
    driver: local
  alertmanager_data:
    driver: local
  promtail_positions:
    driver: local

secrets:
  postgres_password:
    file: ./secrets/postgres_password.txt
  postgres_user:
    file: ./secrets/postgres_user.txt
  postgres_db:
    file: ./secrets/postgres_db.txt
  pgadmin_email:
    file: ./secrets/pgadmin_email.txt
  pgadmin_password:
    file: ./secrets/pgadmin_password.txt
  authenticator_password:
    file: ./secrets/authenticator_password.txt
  crowdsec_bouncer_key:
    file: ./secrets/crowdsec_bouncer_key.txt
  keycloak_admin_password:
    file: ./secrets/keycloak_admin_password.txt
  keycloak_db_password:
    file: ./secrets/keycloak_db_password.txt
  oauth2_client_secret:
    file: ./secrets/oauth2_client_secret.txt
  oauth2_cookie_secret:
    file: ./secrets/oauth2_cookie_secret.txt
  djangocms_db_password:
    file: ./secrets/djangocms_db_password.txt
  django_secret_key:
    file: ./secrets/django_secret_key.txt
  django_superuser_password:
    file: ./secrets/django_superuser_password.txt
  djangocms_keycloak_client_secret:
    file: ./secrets/djangocms_keycloak_client_secret.txt
  # OmniScope secrets
  grafana_admin_password:
    file: ./secrets/grafana_admin_password.txt
  grafana_oauth_client_secret:
    file: ./secrets/grafana_oauth_client_secret.txt

services:
  ###########################################
  # KoolFlows Microservice - Traefik + CrowdSec
  ###########################################

  traefik:
    image: traefik:v3.6
    container_name: koolflows-traefik
    restart: unless-stopped
    networks:
      - web
    ports:
      - "80:80"
      - "8888:8080"  # Dashboard (mapped to 8888 to avoid conflict with CrowdSec)
      - "443:443"    # HTTPS (for future use)
    environment:
      - CROWDSEC_BOUNCER_KEY=${CROWDSEC_BOUNCER_KEY:-placeholder}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./KoolFlows/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./KoolFlows/traefik/dynamic:/etc/traefik/dynamic:ro
      - ./KoolFlows/traefik/plugins-local:/plugins-local:ro
      - traefik_logs:/var/log/traefik
    depends_on:
      crowdsec:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.theddt.local`)"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      - "traefik.http.routers.traefik-dashboard.entrypoints=web"
      - "traefik.http.routers.traefik-dashboard.middlewares=crowdsec-bouncer@file"

  crowdsec:
    build:
      context: ./KoolFlows/crowdsec
      dockerfile: Dockerfile
    container_name: koolflows-crowdsec
    restart: unless-stopped
    networks:
      - web
    ports:
      - "127.0.0.1:8080:8080"
      - "127.0.0.1:7422:7422"
    expose:
      - 8080
      - 6060
      - 7422
    environment:
      - DISABLE_ONLINE_API=true
    secrets:
      - crowdsec_bouncer_key
    volumes:
      - crowdsec_data:/var/lib/crowdsec/data
      - ./KoolFlows/crowdsec/config/acquis.yaml:/etc/crowdsec/acquis.yaml:ro
      - ./KoolFlows/crowdsec/config/profiles.yaml:/etc/crowdsec/profiles.yaml:ro
      - traefik_logs:/var/log/traefik:ro
    healthcheck:
      test: ["CMD", "cscli", "version"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 30s

  ###########################################
  # PeSquel Microservice - Database Services
  ###########################################

  postgres:
    build:
      context: ./PeSquel/postgres
      dockerfile: Dockerfile
    container_name: pesequel-postgres
    restart: unless-stopped
    networks:
      - web
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER_FILE: /run/secrets/postgres_user
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      POSTGRES_DB_FILE: /run/secrets/postgres_db
      PGDATA: /var/lib/postgresql/data/pgdata
      PGSSLMODE: disable
    secrets:
      - postgres_user
      - postgres_password
      - postgres_db
      - authenticator_password
      - keycloak_db_password
      - djangocms_db_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$(cat /run/secrets/postgres_user) -d $$(cat /run/secrets/postgres_db)"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  pgbouncer:
    build:
      context: ./PeSquel/pgbouncer
      dockerfile: Dockerfile
    container_name: pesequel-pgbouncer
    restart: unless-stopped
    networks:
      - web
    environment:
      - PGBOUNCER_DATABASES=keycloak,django_db
      - PGBOUNCER_HOST=postgres
      - PGBOUNCER_PORT=5432
      - PGBOUNCER_AUTH_USER=authenticator
    ports:
      - "6432:6432"
    secrets:
      - postgres_user
      - postgres_password
      - postgres_db
      - authenticator_password
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pgrep -x pgbouncer || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  pgadmin:
    image: dpage/pgadmin4:9.10
    container_name: pesequel-pgadmin
    restart: unless-stopped
    networks:
      - web
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@theddt.com
      PGADMIN_DEFAULT_PASSWORD_FILE: /run/secrets/pgadmin_password
      PGADMIN_CONFIG_SERVER_MODE: "True"
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: "False"
    secrets:
      - pgadmin_password
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      postgres:
        condition: service_healthy
      traefik:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/misc/ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pgadmin.rule=Host(`pgadmin.theddt.local`)"
      - "traefik.http.routers.pgadmin.entrypoints=web"
      - "traefik.http.routers.pgadmin.middlewares=crowdsec-full@file"
      - "traefik.http.services.pgadmin.loadbalancer.server.port=80"

  ###########################################
  # QueWall Microservice - Authentication Services
  ###########################################

  keycloak:
    build:
      context: ./QueWall/keycloak
      dockerfile: Dockerfile
    container_name: quewall-keycloak
    restart: unless-stopped
    networks:
      - web
    command: start-dev --import-realm
    environment:
      # Database configuration
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: keycloak

      # Admin credentials
      KEYCLOAK_ADMIN: admin

      # Server configuration
      KC_HTTP_ENABLED: "true"
      KC_HOSTNAME_STRICT: "false"
      KC_PROXY: edge
      KC_METRICS_ENABLED: "false"
      KC_HEALTH_ENABLED: "true"
    secrets:
      - keycloak_admin_password
      - keycloak_db_password
    volumes:
      - ./QueWall/keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
      - keycloak_data:/opt/keycloak/data 
    depends_on:
      postgres:
        condition: service_healthy
      traefik:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/9000 && echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && cat <&3 | grep -q '200 OK'"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 90s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.keycloak.rule=Host(`keycloak.theddt.local`)"
      - "traefik.http.routers.keycloak.entrypoints=web"
      - "traefik.http.routers.keycloak.middlewares=crowdsec-full@file"
      - "traefik.http.services.keycloak.loadbalancer.server.port=8080"

  oauth2-proxy:
    build:
      context: ./QueWall/oauth2-proxy
      dockerfile: Dockerfile
    container_name: quewall-oauth2-proxy
    restart: unless-stopped
    networks:
      - web
    extra_hosts:
      - "keycloak.theddt.local:host-gateway"  # Route through Docker host to Traefik
    environment:
      # OIDC Provider Configuration
      # Use external issuer URL to match tokens issued by Keycloak
      OAUTH2_PROXY_PROVIDER: oidc
      OAUTH2_PROXY_OIDC_ISSUER_URL: http://keycloak.theddt.local/realms/theddt
      OAUTH2_PROXY_CLIENT_ID: oauth2-proxy-client
      OAUTH2_PROXY_REDIRECT_URL: http://auth.theddt.local/oauth2/callback
      OAUTH2_PROXY_SCOPE: "openid profile email"
      OAUTH2_PROXY_SKIP_OIDC_DISCOVERY: "true"
      OAUTH2_PROXY_INSECURE_OIDC_SKIP_ISSUER_VERIFICATION: "false"
      OAUTH2_PROXY_CODE_CHALLENGE_METHOD: S256

      # Manual OIDC endpoints - use external URL for consistency
      OAUTH2_PROXY_LOGIN_URL: http://keycloak.theddt.local/realms/theddt/protocol/openid-connect/auth
      OAUTH2_PROXY_REDEEM_URL: http://keycloak.theddt.local/realms/theddt/protocol/openid-connect/token
      OAUTH2_PROXY_OIDC_JWKS_URL: http://keycloak.theddt.local/realms/theddt/protocol/openid-connect/certs
      OAUTH2_PROXY_PROFILE_URL: http://keycloak.theddt.local/realms/theddt/protocol/openid-connect/userinfo

      # Whitelist Configuration
      OAUTH2_PROXY_WHITELIST_DOMAINS: .theddt.local

      # Cookie Configuration
      OAUTH2_PROXY_COOKIE_DOMAINS: .theddt.local
      OAUTH2_PROXY_COOKIE_SECURE: "false"
      OAUTH2_PROXY_COOKIE_NAME: _oauth2_proxy
      OAUTH2_PROXY_COOKIE_SAMESITE: lax
      OAUTH2_PROXY_COOKIE_CSRF_PER_REQUEST: "false"
      OAUTH2_PROXY_COOKIE_CSRF_EXPIRE: "15m"

      # Server Configuration
      OAUTH2_PROXY_HTTP_ADDRESS: 0.0.0.0:4180
      OAUTH2_PROXY_REVERSE_PROXY: "true"
      OAUTH2_PROXY_PASS_ACCESS_TOKEN: "true"
      OAUTH2_PROXY_PASS_USER_HEADERS: "true"
      OAUTH2_PROXY_SET_XAUTHREQUEST: "true"

      # Email and Groups
      OAUTH2_PROXY_EMAIL_DOMAINS: "*"
      OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: "false"

      # Upstream - route authenticated requests to Django
      OAUTH2_PROXY_UPSTREAMS: http://djangocms:8000
    secrets:
      - oauth2_client_secret
      - oauth2_cookie_secret
    depends_on:
      keycloak:
        condition: service_healthy
      traefik:
        condition: service_started
      djangocms:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      # OAuth2 endpoints on auth.theddt.local
      - "traefik.http.routers.oauth2-endpoints.rule=Host(`auth.theddt.local`)"
      - "traefik.http.routers.oauth2-endpoints.entrypoints=web"
      - "traefik.http.routers.oauth2-endpoints.middlewares=crowdsec-full@file"
      - "traefik.http.routers.oauth2-endpoints.service=oauth2-proxy"
      - "traefik.http.routers.oauth2-endpoints.priority=10"
      # Service definition
      - "traefik.http.services.oauth2-proxy.loadbalancer.server.port=4180"

  ###########################################
  # Django CMS Backend Application
  ###########################################

  djangocms:
    build:
      context: ./djangocms
      dockerfile: Dockerfile
    container_name: djangocms-app
    restart: unless-stopped
    networks:
      - web
    environment:
      # Application Mode
      DJANGO_ENV: dev
      DATABASE: postgres

      # Database Connection (mapping to settings.py SQL_* variables)
      SQL_ENGINE: django.db.backends.postgresql
      SQL_DATABASE: django_db
      SQL_USER: djangocms
      SQL_HOST: postgres
      SQL_PORT: 5432
      # SQL_PASSWORD loaded from secret in entrypoint

      # Django Configuration
      # SECRET_KEY loaded from secret in entrypoint
      DEBUG: "True"
      DOMAIN: api.theddt.local
      SECURE_SSL_REDIRECT: "False"

      # Superuser Configuration
      DJANGO_SUPERUSER_USERNAME: admin
      DJANGO_SUPERUSER_EMAIL: admin@theddt.com
      # DJANGO_SUPERUSER_PASSWORD loaded from secret in entrypoint

      # Storage
      DEFAULT_STORAGE_DSN: file:///data/media/?url=%2Fmedia%2F

      # Payment Gateway (localstripe for testing)
      USE_LOCALSTRIPE: "True"
      STRIPE_API_KEY: sk_test_123
      STRIPE_WEBHOOK_SECRET: whsec_123
      PAYMENT_HOST: api.theddt.local
      PAYMENT_USES_SSL: "False"

      # Celery/Redis (optional, can add later)
      # REDIS_URL: redis://localhost:6379/0

      # Keycloak Configuration
      KEYCLOAK_SERVER_URL: http://keycloak:8080  # Internal Docker network (for admin API)
      KEYCLOAK_ISSUER: http://keycloak.theddt.local/realms/theddt  # Public URL (for JWT validation)
      KEYCLOAK_REALM: theddt
      KEYCLOAK_CLIENT_ID: djangocms-client
      # KEYCLOAK_CLIENT_SECRET loaded from secret in entrypoint

    secrets:
      - djangocms_db_password
      - django_secret_key
      - django_superuser_password
      - djangocms_keycloak_client_secret

    volumes:
      - djangocms_media:/data/media
      - djangocms_static:/app/staticfiles

    depends_on:
      postgres:
        condition: service_healthy
      traefik:
        condition: service_started

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8000/admin/login/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    labels:
      - "traefik.enable=true"

      # API Routes (JWT only, no OAuth2-Proxy) - direct to Django
      - "traefik.http.routers.djangocms-api.rule=Host(`api.theddt.local`) && PathPrefix(`/api/`)"
      - "traefik.http.routers.djangocms-api.entrypoints=web"
      - "traefik.http.routers.djangocms-api.middlewares=crowdsec-full@file"
      - "traefik.http.routers.djangocms-api.service=djangocms"
      - "traefik.http.routers.djangocms-api.priority=30"

      # Static files - direct to Django (no auth needed)
      - "traefik.http.routers.djangocms-static.rule=Host(`api.theddt.local`) && PathPrefix(`/static/`)"
      - "traefik.http.routers.djangocms-static.entrypoints=web"
      - "traefik.http.routers.djangocms-static.middlewares=crowdsec-full@file"
      - "traefik.http.routers.djangocms-static.service=djangocms"
      - "traefik.http.routers.djangocms-static.priority=30"

      # Admin Routes - direct to Django (username/password auth)
      - "traefik.http.routers.djangocms-admin.rule=Host(`api.theddt.local`) && PathPrefix(`/admin/`)"
      - "traefik.http.routers.djangocms-admin.entrypoints=web"
      - "traefik.http.routers.djangocms-admin.middlewares=crowdsec-full@file"
      - "traefik.http.routers.djangocms-admin.service=djangocms"
      - "traefik.http.routers.djangocms-admin.priority=20"

      # CMS Routes - direct to Django (catch-all for CMS pages)
      - "traefik.http.routers.djangocms-cms.rule=Host(`api.theddt.local`)"
      - "traefik.http.routers.djangocms-cms.entrypoints=web"
      - "traefik.http.routers.djangocms-cms.middlewares=crowdsec-full@file"
      - "traefik.http.routers.djangocms-cms.service=djangocms"
      - "traefik.http.routers.djangocms-cms.priority=10"

      # Service definition (direct Django access)
      - "traefik.http.services.djangocms.loadbalancer.server.port=8000"

  ###########################################
  # OmniScope Microservice - Monitoring Stack
  ###########################################

  grafana:
    image: grafana/grafana:10.2.0
    container_name: omniscope-grafana
    restart: unless-stopped
    networks:
      - web
    user: "0"
    environment:
      # Admin Configuration
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD__FILE: /run/secrets/grafana_admin_password

      # Server Configuration
      GF_SERVER_DOMAIN: omniscope.theddt.local
      GF_SERVER_ROOT_URL: http://omniscope.theddt.local/
      GF_SERVER_HTTP_PORT: 3000

      # Plugin Installation
      GF_INSTALL_PLUGINS: grafana-piechart-panel

      # Disable signup
      GF_USERS_ALLOW_SIGN_UP: "false"

      # OAuth Configuration (Keycloak)
      GF_AUTH_GENERIC_OAUTH_ENABLED: "true"
      GF_AUTH_GENERIC_OAUTH_NAME: Keycloak
      GF_AUTH_GENERIC_OAUTH_CLIENT_ID: grafana-client
      GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET__FILE: /run/secrets/grafana_oauth_client_secret
      GF_AUTH_GENERIC_OAUTH_SCOPES: openid profile email roles
      GF_AUTH_GENERIC_OAUTH_AUTH_URL: http://keycloak.theddt.local/realms/theddt/protocol/openid-connect/auth
      GF_AUTH_GENERIC_OAUTH_TOKEN_URL: http://keycloak:8080/realms/theddt/protocol/openid-connect/token
      GF_AUTH_GENERIC_OAUTH_API_URL: http://keycloak:8080/realms/theddt/protocol/openid-connect/userinfo
      GF_AUTH_GENERIC_OAUTH_ALLOW_SIGN_UP: "true"
      GF_AUTH_GENERIC_OAUTH_ROLE_ATTRIBUTE_PATH: "contains(roles[*], 'admin') && 'Admin' || contains(roles[*], 'editor') && 'Editor' || 'Viewer'"
      GF_AUTH_GENERIC_OAUTH_USE_PKCE: "true"

      # Disable anonymous access
      GF_AUTH_ANONYMOUS_ENABLED: "false"

      # Logging
      GF_LOG_MODE: console
      GF_LOG_LEVEL: info
    secrets:
      - grafana_admin_password
      - grafana_oauth_client_secret
    volumes:
      - grafana_data:/var/lib/grafana
      - ./OmniScope/grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      prometheus:
        condition: service_healthy
      loki:
        condition: service_healthy
      keycloak:
        condition: service_healthy
      traefik:
        condition: service_started
    extra_hosts:
      - "keycloak.theddt.local:host-gateway"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`omniscope.theddt.local`)"
      - "traefik.http.routers.grafana.entrypoints=web"
      - "traefik.http.routers.grafana.middlewares=crowdsec-full@file"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"

  prometheus:
    image: prom/prometheus:v2.48.1
    container_name: omniscope-prometheus
    restart: unless-stopped
    networks:
      - web
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.console.libraries=/etc/prometheus/console_libraries"
      - "--web.console.templates=/etc/prometheus/consoles"
      - "--storage.tsdb.retention.time=200h"
      - "--web.enable-lifecycle"
      - "--web.enable-remote-write-receiver"
    volumes:
      - ./OmniScope/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./OmniScope/prometheus/rules:/etc/prometheus/rules:ro
      - prometheus_data:/prometheus
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prometheus.rule=Host(`prometheus.theddt.local`)"
      - "traefik.http.routers.prometheus.entrypoints=web"
      - "traefik.http.routers.prometheus.middlewares=crowdsec-full@file"
      - "traefik.http.services.prometheus.loadbalancer.server.port=9090"

  loki:
    image: grafana/loki:2.9.0
    container_name: omniscope-loki
    restart: unless-stopped
    networks:
      - web
    volumes:
      - ./OmniScope/loki/loki-config.yml:/etc/loki/local-config.yaml:ro
      - loki_data:/loki
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  alertmanager:
    image: prom/alertmanager:v0.27.0
    container_name: omniscope-alertmanager
    restart: unless-stopped
    networks:
      - web
    command:
      - "--config.file=/etc/alertmanager/alertmanager.yml"
      - "--storage.path=/alertmanager"
      - "--web.external-url=http://alertmanager.theddt.local/"
    volumes:
      - ./OmniScope/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager_data:/alertmanager
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9093/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.alertmanager.rule=Host(`alertmanager.theddt.local`)"
      - "traefik.http.routers.alertmanager.entrypoints=web"
      - "traefik.http.routers.alertmanager.middlewares=crowdsec-full@file"
      - "traefik.http.services.alertmanager.loadbalancer.server.port=9093"

  ###########################################
  # OmniScope Exporters - System Metrics
  ###########################################

  node-exporter:
    image: prom/node-exporter:v1.7.0
    container_name: omniscope-node-exporter
    restart: unless-stopped
    networks:
      - web
    command:
      - "--path.procfs=/host/proc"
      - "--path.sysfs=/host/sys"
      - "--path.rootfs=/rootfs"
      - "--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9100/metrics"]
      interval: 10s
      timeout: 5s
      retries: 3

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.47.2
    container_name: omniscope-cadvisor
    restart: unless-stopped
    networks:
      - web
    privileged: true
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3

  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:v0.15.0
    container_name: omniscope-postgres-exporter
    restart: unless-stopped
    networks:
      - web
    command:
      - "--collector.stat_bgwriter=false"
    environment:
      DATA_SOURCE_URI: postgres:5432/pesequel_db?sslmode=disable
      DATA_SOURCE_USER_FILE: /run/secrets/postgres_user
      DATA_SOURCE_PASS_FILE: /run/secrets/postgres_password
    secrets:
      - postgres_user
      - postgres_password
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9187/metrics"]
      interval: 10s
      timeout: 5s
      retries: 3

  ###########################################
  # OmniScope Log Aggregation - Promtail
  ###########################################

  promtail:
    image: grafana/promtail:3.0.0
    container_name: omniscope-promtail
    restart: unless-stopped
    networks:
      - web
    command: -config.file=/etc/promtail/promtail-config.yml
    volumes:
      - ./OmniScope/promtail/promtail-config.yml:/etc/promtail/promtail-config.yml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - promtail_positions:/positions
      - traefik_logs:/var/log/traefik:ro
    depends_on:
      loki:
        condition: service_healthy

  ###########################################
  # OmniScope Load Testing (On-Demand)
  ###########################################

  k6:
    image: grafana/k6:latest
    container_name: omniscope-k6
    networks:
      - web
    profiles:
      - tools
    environment:
      K6_PROMETHEUS_RW_SERVER_URL: http://prometheus:9090/api/v1/write
      K6_PROMETHEUS_RW_TREND_AS_NATIVE_HISTOGRAM: "true"
    volumes:
      - ./OmniScope/k6/scripts:/scripts:ro
