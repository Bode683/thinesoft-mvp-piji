version: "3.8"

networks:
  quewall-network:
    driver: bridge
    name: quewall-network

volumes:
  postgres_data:
    driver: local

secrets:
  keycloak_admin_password:
    file: ./secrets/keycloak_admin_password.txt
  postgres_password:
    file: ./secrets/postgres_password.txt
  oauth2_client_secret:
    file: ./secrets/oauth2_client_secret.txt
  oauth2_cookie_secret:
    file: ./secrets/oauth2_cookie_secret.txt

services:
  postgres:
    image: postgres:${POSTGRES_VERSION:-16-alpine}
    container_name: quewall-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-keycloak}
      POSTGRES_USER: ${POSTGRES_USER:-keycloak}
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - quewall-network
    secrets:
      - postgres_password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak -d keycloak"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    expose:
      - "5432"

  keycloak:
    image: quay.io/keycloak/keycloak:${KEYCLOAK_VERSION:-23.0}
    container_name: quewall-keycloak
    command: start-dev --import-realm
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: ${POSTGRES_USER:-keycloak}
      KC_DB_PASSWORD_FILE: /run/secrets/postgres_password
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD_FILE: /run/secrets/keycloak_admin_password
      KC_HTTP_ENABLED: "true"
      KC_HOSTNAME_STRICT: "false"
      KC_PROXY: edge
      KC_METRICS_ENABLED: "false"
    volumes:
      - ./keycloak/realm-export-generated.json:/opt/keycloak/data/import/theddt-realm.json:ro
    networks:
      - quewall-network
    secrets:
      - postgres_password
      - keycloak_admin_password
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health/ready || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 20s
    restart: unless-stopped
    expose:
      - "8080"
    depends_on:
      postgres:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.keycloak.rule=Host(`keycloak.theddt.local`)"
      - "traefik.http.routers.keycloak.entrypoints=web"
      - "traefik.http.services.keycloak.loadbalancer.server.port=8080"

  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:${OAUTH2_PROXY_VERSION:-latest}
    container_name: quewall-oauth2-proxy
    environment:
      OAUTH2_PROXY_PROVIDER: oidc
      OAUTH2_PROXY_OIDC_ISSUER_URL: http://keycloak:8080/realms/theddt
      OAUTH2_PROXY_CLIENT_ID: oauth2-proxy-client
      OAUTH2_PROXY_CLIENT_SECRET_FILE: /run/secrets/oauth2_client_secret
      OAUTH2_PROXY_COOKIE_SECRET_FILE: /run/secrets/oauth2_cookie_secret
      OAUTH2_PROXY_REDIRECT_URL: http://auth.theddt.local/oauth2/callback
      OAUTH2_PROXY_HTTP_ADDRESS: 0.0.0.0:4180
      OAUTH2_PROXY_UPSTREAMS: http://whoami:80
      OAUTH2_PROXY_EMAIL_DOMAINS: "*"
      OAUTH2_PROXY_COOKIE_SECURE: "false"
      OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: "true"
      OAUTH2_PROXY_SET_XAUTHREQUEST: "true"
      OAUTH2_PROXY_COOKIE_DOMAIN: .theddt.local
      OAUTH2_PROXY_PASS_USER_HEADERS: "true"
      OAUTH2_PROXY_PASS_AUTHORIZATION_HEADER: "true"
      OAUTH2_PROXY_SCOPE: openid profile email groups
      OAUTH2_PROXY_LOGGING_LEVEL: info
    networks:
      - quewall-network
    secrets:
      - oauth2_client_secret
      - oauth2_cookie_secret
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4180/ping || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    expose:
      - "4180"
    depends_on:
      keycloak:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.oauth2.rule=Host(`auth.theddt.local`)"
      - "traefik.http.routers.oauth2.entrypoints=web"
      - "traefik.http.services.oauth2.loadbalancer.server.port=4180"

  whoami:
    image: traefik/whoami:latest
    container_name: quewall-whoami
    networks:
      - quewall-network
    expose:
      - "80"
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.whoami.rule=Host(`app.theddt.local`)"
      - "traefik.http.routers.whoami.entrypoints=web"
      - "traefik.http.routers.whoami.middlewares=oauth2-auth"
      - "traefik.http.services.whoami.loadbalancer.server.port=80"

  traefik:
    image: traefik:${TRAEFIK_VERSION:-v2.11}
    container_name: quewall-traefik
    command:
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --log.level=info
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - quewall-network
    restart: unless-stopped
    depends_on:
      - postgres
      - keycloak
      - oauth2-proxy
      - whoami
    labels:
      - "traefik.enable=true"
      - "traefik.http.middlewares.oauth2-auth.forwardauth.address=http://oauth2-proxy:4180/oauth2/auth"
      - "traefik.http.middlewares.oauth2-auth.forwardauth.trustForwardHeader=true"
      - "traefik.http.middlewares.oauth2-auth.forwardauth.authResponseHeaders=X-Auth-Request-User,X-Auth-Request-Email,X-Auth-Request-Preferred-Username,X-Auth-Request-Groups"
