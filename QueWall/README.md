# QueWall - Authentication Infrastructure Stack

An MVP authentication infrastructure stack with **Traefik**, **Keycloak**, **oauth2-proxy**, and a test service. This is a complete, ready-to-run Docker Compose setup that provides single sign-on (SSO) through Keycloak for protecting any HTTP service.

## Architecture

```
Browser
  ↓
Traefik (reverse proxy, port 80)
  ├─→ ForwardAuth middleware
  │   ↓
  └─→ oauth2-proxy:4180/oauth2/auth
      ↓
      Keycloak:8080 (OIDC provider)
      ↓
      PostgreSQL:5432 (database)
```

**Key Components:**
- **Traefik**: Reverse proxy that routes requests and enforces authentication via ForwardAuth middleware
- **Keycloak**: OpenID Connect (OIDC) identity provider with user management
- **oauth2-proxy**: OIDC client that handles login flows and injects user headers
- **PostgreSQL**: Database backend for Keycloak
- **whoami**: Test service to verify authentication and header injection

## Quick Start

### Prerequisites

- Docker and Docker Compose installed
- `openssl` command (for secret generation)
- ~2GB free disk space
- Port 80 and 8080 available

### 1. Clone or download this project

```bash
cd QueWall
```

### 2. Run setup script

```bash
./setup.sh
```

This script will:
- Generate cryptographically secure secrets
- Create Docker network
- Start all services in correct order with health checks
- Display access URLs and credentials

### 3. Add hosts entries

Add these lines to your hosts file:

**Linux/macOS:** `/etc/hosts`
**Windows:** `C:\Windows\System32\drivers\etc\hosts`

```
127.0.0.1 keycloak.theddt.local
127.0.0.1 auth.theddt.local
127.0.0.1 app.theddt.local
```

### 4. Access the services

- **Protected App**: http://app.theddt.local
  - First access will redirect to Keycloak login
  - Login with: `testuser` / `password123`
  - After login, you'll see the whoami service displaying your authenticated headers

- **Keycloak Admin Console**: http://keycloak.theddt.local
  - Username: `admin`
  - Password: Check `secrets/keycloak_admin_password.txt`

- **Traefik Dashboard**: http://localhost:8080
  - Monitoring dashboard for Traefik (no auth required)

### 5. Verify authentication flow

1. Open http://app.theddt.local in your browser
2. You should be redirected to Keycloak login page
3. Login with `testuser` / `password123`
4. You should be redirected back to the whoami service
5. You should see your authenticated user info in the HTTP headers (look for `X-Auth-Request-*` headers)

## Configuration

### Environment Variables

Copy `.env.example` to `.env` for custom configuration:

```bash
cp .env.example .env
```

Modify values as needed for:
- Service versions
- Domain names (if not using theddt.local)
- Project name

### Secrets

All sensitive values are stored in `secrets/` directory:
- `keycloak_admin_password.txt` - Keycloak admin password
- `postgres_password.txt` - PostgreSQL password
- `oauth2_client_secret.txt` - OIDC client secret
- `oauth2_cookie_secret.txt` - Session cookie encryption secret

Secrets are automatically generated by `setup.sh`. To regenerate them:

```bash
rm -rf secrets/
./setup.sh
```

### Keycloak Realm Configuration

The realm `theddt` is pre-configured with:
- **Realm name**: `theddt`
- **Client**: `oauth2-proxy-client` (confidential OIDC client)
- **Test user**: `testuser` / `password123`
- **Redirect URIs**: `http://auth.theddt.local/oauth2/callback`

To modify realm settings:
1. Login to http://keycloak.theddt.local with admin credentials
2. Select realm `theddt` in top-left dropdown
3. Make changes as needed

## API Discovery

The OpenID Connect discovery endpoint is available at:

```
http://keycloak.theddt.local/realms/theddt/.well-known/openid-configuration
```

This endpoint can be used by API portals and automation tools for service discovery and assessment.

## Adding Protected Services

To protect additional services with the same authentication stack, add them to `docker-compose.yml`:

```yaml
your-service:
  image: your-service:latest
  networks:
    - quewall-network
  labels:
    - "traefik.enable=true"
    - "traefik.http.routers.your-service.rule=Host(`your-service.theddt.local`)"
    - "traefik.http.routers.your-service.entrypoints=web"
    - "traefik.http.routers.your-service.middlewares=oauth2-auth"
    - "traefik.http.services.your-service.loadbalancer.server.port=8000"
```

Your service will automatically require authentication and receive user headers:
- `X-Auth-Request-User` - User email/username
- `X-Auth-Request-Email` - User email
- `X-Auth-Request-Preferred-Username` - Preferred username
- `X-Auth-Request-Groups` - User groups (JSON array)

## Cleanup

To stop all services and remove containers:

```bash
./teardown.sh
```

To keep data volumes for next setup:

```bash
./teardown.sh --keep-volumes
```

To completely remove secrets and start fresh:

```bash
./teardown.sh --clean-secrets
```

Force teardown without confirmation:

```bash
./teardown.sh --force
```

## Troubleshooting

### "Cannot connect to keycloak.theddt.local"

Make sure you've added the hosts entries. Check:

**Linux/macOS:**
```bash
cat /etc/hosts | grep theddt.local
```

**Windows:**
```powershell
type C:\Windows\System32\drivers\etc\hosts | findstr theddt.local
```

### "Connection refused" on port 80

Port 80 is already in use. Check what's using it:

**Linux/macOS:**
```bash
sudo lsof -i :80
```

**Windows:**
```powershell
netstat -ano | findstr :80
```

### Keycloak not starting

Check logs:
```bash
docker-compose logs keycloak
```

Common issues:
- Postgres not ready (wait a moment and check: `docker-compose logs postgres`)
- Database initialization timeout (increase wait time in setup.sh)

### Services not healthy

Check individual service logs:
```bash
docker-compose logs postgres
docker-compose logs keycloak
docker-compose logs oauth2-proxy
docker-compose logs traefik
```

### "302 Found" instead of login page

The oauth2-proxy might not be ready yet. Wait 30 seconds and refresh the browser.

### Header injection not working

Make sure Traefik is using the `oauth2-auth` middleware. Check:
```bash
docker-compose logs traefik | grep oauth2-auth
```

For more detailed troubleshooting, see `docs/TROUBLESHOOTING.md`.

## Test Credentials

- **Username**: `testuser`
- **Email**: `testuser@theddt.local`
- **Password**: `password123`

## Architecture Details

For detailed architecture documentation, see `docs/ARCHITECTURE.md`.

## Known Limitations (MVP)

1. **HTTP Only** - No TLS/HTTPS (suitable for development/local testing only)
2. **In-Memory Sessions** - oauth2-proxy stores sessions in memory; restarting the container will log out users
3. **Single Test User** - For production, add proper user management or LDAP/AD integration
4. **No Rate Limiting** - Add Traefik rate limiting middleware for production
5. **Development Mode** - Keycloak runs in `start-dev` mode; use production mode for actual deployments

## Next Steps for Production

Before deploying to production:
1. Enable TLS/HTTPS with proper certificates
2. Set up persistent session storage (Redis)
3. Configure real Keycloak database with backups
4. Add rate limiting and request validation
5. Set up monitoring and logging
6. Configure LDAP/AD for enterprise user management
7. Add secret rotation procedures
8. Set up automated backups

## References

- [Traefik ForwardAuth Documentation](https://doc.traefik.io/traefik/middlewares/http/forwardauth/)
- [OAuth2 Proxy Documentation](https://oauth2-proxy.github.io/oauth2-proxy/)
- [Keycloak Documentation](https://www.keycloak.org/documentation.html)
- [Docker Compose Secrets](https://docs.docker.com/compose/how-tos/use-secrets/)

## Support

For issues and troubleshooting:
1. Check `docs/TROUBLESHOOTING.md` for common problems
2. Review service logs with `docker-compose logs <service>`
3. Verify hosts file configuration
4. Ensure ports 80, 8080, and 5432 are available

## License

This MVP stack is provided as-is for development and testing purposes.
