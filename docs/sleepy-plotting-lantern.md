# QueWall MVP Authentication Infrastructure - Implementation Plan

## Overview
Implement a complete Docker-based authentication infrastructure stack (QueWall) with Traefik reverse proxy, Keycloak OIDC provider, oauth2-proxy ForwardAuth middleware, and a test whoami service. The stack will be ready-to-run with automated setup/teardown scripts and Docker secrets for sensitive values.

## Architecture

```
Client Browser
    ↓
Traefik (reverse proxy, port 80)
    ↓
ForwardAuth → oauth2-proxy:4180/oauth2/auth
    ↓
oauth2-proxy ← OIDC → Keycloak:8080
    ↓
Protected Services (whoami)
    ↑
Keycloak ← Postgres:5432
```

**Hostnames** (via /etc/hosts):
- `keycloak.theddt.local` - Keycloak admin console & OIDC provider
- `auth.theddt.local` - oauth2-proxy authentication endpoint
- `app.theddt.local` - Protected whoami test service

## Directory Structure

```
QueWall/
├── docker-compose.yml              # Main orchestration file
├── setup.sh                        # Initialization script (generates secrets, starts services)
├── teardown.sh                     # Cleanup script (stops services, removes volumes)
├── .env.example                    # Environment variable template
├── .gitignore                      # Exclude secrets and generated files
├── README.md                       # User-facing documentation
├── secrets/                        # Docker secrets (gitignored)
│   ├── keycloak_admin_password.txt
│   ├── postgres_password.txt
│   ├── oauth2_client_secret.txt
│   └── oauth2_cookie_secret.txt
├── keycloak/
│   └── realm-export.json           # Pre-configured theddt realm with oauth2-proxy client
└── docs/
    ├── ARCHITECTURE.md
    └── TROUBLESHOOTING.md
```

## Critical Design Decisions

### 1. Secret Management
Use Docker secrets (file-based) for all sensitive values:
- `keycloak_admin_password` - Keycloak admin console password
- `postgres_password` - PostgreSQL database password
- `oauth2_client_secret` - OIDC client secret for oauth2-proxy (32 bytes)
- `oauth2_cookie_secret` - Cookie encryption secret (32 bytes base64)

Generated by setup.sh using `openssl rand -base64 32`.

### 2. Networking
Single Docker bridge network `quewall-network`:
- Internal DNS: Services communicate via container names (e.g., `keycloak:8080`)
- External access: Only through Traefik using *.theddt.local hostnames

### 3. Keycloak Realm Import
Use `--import-realm` flag with pre-configured `realm-export.json`:
- Realm name: `theddt`
- Client ID: `oauth2-proxy-client` (confidential client)
- Redirect URI: `http://auth.theddt.local/oauth2/callback`
- Protocol mappers: audience, groups, email, preferred_username
- Test user: `testuser` / `password123`

**Secret synchronization**: setup.sh will generate client secret, then sed-replace placeholder in realm-export.json before mount.

### 4. Traefik ForwardAuth Configuration
Middleware defined via Docker labels:
```yaml
traefik.http.middlewares.oauth2-auth.forwardauth.address=http://oauth2-proxy:4180/oauth2/auth
traefik.http.middlewares.oauth2-auth.forwardauth.trustForwardHeader=true
traefik.http.middlewares.oauth2-auth.forwardauth.authResponseHeaders=X-Auth-Request-User,X-Auth-Request-Email,X-Auth-Request-Preferred-Username,X-Auth-Request-Groups
```

Protected services attach this middleware to their router.

### 5. oauth2-proxy Configuration
Environment variables + Docker secrets:
- `OAUTH2_PROXY_OIDC_ISSUER_URL=http://keycloak:8080/realms/theddt` (container DNS)
- `OAUTH2_PROXY_REDIRECT_URL=http://auth.theddt.local/oauth2/callback` (external URL)
- `OAUTH2_PROXY_COOKIE_DOMAIN=.theddt.local` (leading dot for subdomain sharing)
- `OAUTH2_PROXY_COOKIE_SECURE=false` (HTTP only for MVP)
- `OAUTH2_PROXY_SET_XAUTHREQUEST=true` (inject headers)

## Implementation Steps

### Phase 1: Project Structure & Configuration Files (1-2 hours)

1. **Create directory structure**
   - Create `secrets/`, `keycloak/`, `docs/` directories
   - Create `.gitignore` to exclude `secrets/`, `.env`, generated files

2. **Create `.env.example`**
   - Template for optional environment variables
   - Document service versions, domain names

3. **Create `README.md`**
   - Quick start instructions
   - Hosts file entries required
   - Test credentials
   - Architecture overview

### Phase 2: Docker Compose Orchestration (2-3 hours)

4. **Create `docker-compose.yml`**

   **Services in order:**

   a. **postgres** (PostgreSQL 16-alpine)
   - Environment: `POSTGRES_DB=keycloak`, `POSTGRES_USER=keycloak`, password from secret
   - Volume: `postgres_data:/var/lib/postgresql/data`
   - Healthcheck: `pg_isready`

   b. **keycloak** (quay.io/keycloak/keycloak:23.0)
   - Command: `start-dev --import-realm`
   - Environment:
     - KC_DB=postgres, KC_DB_URL=jdbc:postgresql://postgres:5432/keycloak
     - KC_PROXY=edge, KC_HTTP_ENABLED=true, KC_HOSTNAME_STRICT=false
     - Admin credentials from secrets
   - Volume: `./keycloak/realm-export-generated.json:/opt/keycloak/data/import/theddt-realm.json:ro`
   - Depends_on: postgres (with healthcheck)
   - Traefik labels: Host(`keycloak.theddt.local`), port 8080

   c. **oauth2-proxy** (quay.io/oauth2-proxy/oauth2-proxy:latest)
   - Environment: Provider=oidc, issuer URL, client ID, redirect URL, cookie settings
   - Secrets: client_secret, cookie_secret (via _FILE env vars)
   - Depends_on: keycloak
   - Traefik labels: Host(`auth.theddt.local`), port 4180

   d. **whoami** (traefik/whoami:latest)
   - Traefik labels:
     - Host(`app.theddt.local`)
     - Middlewares: `oauth2-auth` (ForwardAuth)
     - Port 80

   e. **traefik** (traefik:v2.11)
   - Command: api.insecure=true, providers.docker=true, exposedbydefault=false, entrypoints.web.address=:80
   - Ports: 80:80, 8080:8080 (dashboard)
   - Volume: `/var/run/docker.sock:/var/run/docker.sock:ro`
   - Labels: Define oauth2-auth ForwardAuth middleware

   **Networks:**
   - `quewall-network` (bridge driver)

   **Volumes:**
   - `postgres_data`

   **Secrets:**
   - All 4 secrets defined with `file: ./secrets/<name>.txt`

### Phase 3: Keycloak Realm Configuration (1-2 hours)

5. **Create `keycloak/realm-export.json`**
   - Realm: "theddt", sslRequired: "none"
   - Client: "oauth2-proxy-client"
     - Type: confidential
     - Secret: `OAUTH2_CLIENT_SECRET_PLACEHOLDER` (will be replaced by setup.sh)
     - Redirect URIs: `http://auth.theddt.local/oauth2/callback`
     - Standard Flow Enabled: true
   - Protocol Mappers:
     - Audience mapper (add client to aud claim)
     - Groups mapper (groups claim for authorization)
     - Email, preferred_username (standard claims)
   - Test user: username=testuser, email=testuser@theddt.local, password=password123

### Phase 4: Setup Script (2-3 hours)

6. **Create `setup.sh`**

   **Functions:**
   - `check_prerequisites()`: Verify docker, docker-compose, openssl installed
   - `generate_secret()`: Generate cryptographically secure random secrets
   - `wait_for_service()`: Poll health endpoint with timeout

   **Main flow:**
   ```bash
   1. Check prerequisites
   2. Create secrets/ directory
   3. Generate all 4 secrets (skip if already exist)
   4. Validate keycloak/realm-export.json exists
   5. Sed-replace OAUTH2_CLIENT_SECRET_PLACEHOLDER with actual secret → realm-export-generated.json
   6. Create Docker network (ignore if exists)
   7. Start postgres → wait for pg_isready
   8. Start keycloak → wait for /health/ready
   9. Start oauth2-proxy → wait for /ping
   10. Start traefik and whoami
   11. Display success message with:
       - Hosts file entries
       - Access URLs
       - Admin credentials
   ```

   Make script idempotent and handle errors gracefully.

### Phase 5: Teardown Script (1 hour)

7. **Create `teardown.sh`**

   **Features:**
   - Confirmation prompt (skip with --force)
   - Flags: --keep-volumes, --clean-secrets

   **Flow:**
   ```bash
   1. Confirm with user (unless --force)
   2. docker-compose down
   3. Remove volumes (unless --keep-volumes)
   4. Remove network
   5. Optionally remove secrets/ (if --clean-secrets)
   6. Display completion message
   ```

### Phase 6: Documentation (2-3 hours)

8. **Complete `README.md`**
   - Quick start (setup.sh, hosts entries, access URLs)
   - Architecture diagram (ASCII or mermaid)
   - Configuration options
   - Test credentials
   - Troubleshooting basics
   - Cleanup instructions

9. **Create `docs/ARCHITECTURE.md`**
   - Component descriptions
   - Authentication flow sequence diagram
   - Network topology
   - Security considerations (HTTP limitation, secret management)
   - Data persistence strategy

10. **Create `docs/TROUBLESHOOTING.md`**
    - "Cannot connect to Keycloak" solutions
    - DNS/hosts file issues
    - Port conflict resolution
    - Container health check failures
    - Debug commands (docker logs, docker inspect, curl tests)

### Phase 7: Testing & Validation (2-4 hours)

11. **Integration testing**
    - Fresh directory → run setup.sh → verify all services healthy
    - Add hosts entries
    - Access http://app.theddt.local → should redirect to Keycloak
    - Login with testuser/password123 → should redirect to whoami
    - Verify X-Auth-Request-* headers displayed by whoami
    - Access http://keycloak.theddt.local → admin console accessible
    - Test logout flow
    - Run teardown.sh → verify clean removal
    - Re-run setup.sh → verify idempotency

12. **Edge case testing**
    - Port conflicts (80, 8080, 5432 already in use)
    - Missing prerequisites
    - Partial failure recovery
    - Re-generating secrets
    - Windows compatibility (Git Bash/WSL2)

## Critical Files to Create

1. **docker-compose.yml** - Core orchestration (all services, secrets, networks, volumes)
2. **setup.sh** - Automated initialization with secret generation and health checks
3. **keycloak/realm-export.json** - Pre-configured theddt realm with oauth2-proxy client
4. **teardown.sh** - Clean removal of all resources
5. **README.md** - User-facing quick start and documentation
6. **secrets/** directory structure (created by setup.sh)
7. **.gitignore** - Exclude secrets and generated files
8. **.env.example** - Configuration template
9. **docs/ARCHITECTURE.md** - Technical architecture details
10. **docs/TROUBLESHOOTING.md** - Common issues and solutions

## Key Configuration Values

### Keycloak
- Admin username: `admin`
- Admin password: Generated by setup.sh → `secrets/keycloak_admin_password.txt`
- Realm: `theddt`
- Database: PostgreSQL on `postgres:5432`

### oauth2-proxy
- Client ID: `oauth2-proxy-client`
- Client secret: Generated by setup.sh → `secrets/oauth2_client_secret.txt`
- Cookie secret: Generated by setup.sh → `secrets/oauth2_cookie_secret.txt`
- Issuer URL (internal): `http://keycloak:8080/realms/theddt`
- Redirect URL (external): `http://auth.theddt.local/oauth2/callback`
- Cookie domain: `.theddt.local`

### Postgres
- Database: `keycloak`
- User: `keycloak`
- Password: Generated by setup.sh → `secrets/postgres_password.txt`

### Test User
- Username: `testuser`
- Email: `testuser@theddt.local`
- Password: `password123`

## Discovery Endpoint
Keycloak OIDC discovery available at:
`http://keycloak.theddt.local/realms/theddt/.well-known/openid-configuration`

This endpoint can be used by API portals and tools for automated service discovery and assessment.

## Known Limitations (MVP)

1. **HTTP only** - No TLS/HTTPS (document upgrade path for production)
2. **In-memory sessions** - oauth2-proxy sessions lost on restart (suggest Redis for production)
3. **No rate limiting** - Add Traefik rate limiting middleware for production
4. **Single test user** - Add proper user management UI or LDAP integration later
5. **Windows compatibility** - Requires Git Bash or WSL2 for shell scripts

## Success Criteria

✅ Running `./setup.sh` successfully starts all services
✅ Accessing http://app.theddt.local redirects to Keycloak login
✅ Logging in with testuser/password123 grants access to whoami
✅ whoami displays X-Auth-Request-* headers with user info
✅ Keycloak admin console accessible with generated credentials
✅ Discovery endpoint returns valid OIDC configuration
✅ Running `./teardown.sh` cleanly removes all resources
✅ Re-running setup.sh is idempotent
✅ No secrets committed to git
✅ Documentation is complete and accurate

## Potential Issues & Solutions

### Issue: Keycloak client secret mismatch
**Solution**: setup.sh generates secret first, then injects into realm-export.json via sed before mounting

### Issue: OAuth redirect URI mismatch
**Solution**: Use exact URL in both realm-export.json and oauth2-proxy config: `http://auth.theddt.local/oauth2/callback`

### Issue: Cookie not shared between subdomains
**Solution**: Set `OAUTH2_PROXY_COOKIE_DOMAIN=.theddt.local` (leading dot is critical)

### Issue: oauth2-proxy cannot reach Keycloak discovery
**Solution**: Use container DNS name `http://keycloak:8080/realms/theddt` for OIDC_ISSUER_URL, not external hostname

### Issue: Postgres not ready when Keycloak starts
**Solution**: Use depends_on with health check condition in docker-compose.yml + wait logic in setup.sh

### Issue: Port conflicts
**Solution**: Check ports in setup.sh, document port requirements in README, provide alternative port config in .env

### Issue: Windows path and shell compatibility
**Solution**: Document requirement for Git Bash or WSL2, consider adding setup.ps1 for native PowerShell

## Implementation Estimate
**Total time**: 12-18 hours for complete implementation and testing
