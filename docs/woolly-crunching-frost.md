# PeSequel Microservice MVP - Implementation Plan

## Overview
Create a Docker-based microservice stack with Traefik, PostgreSQL, pgAdmin, PostgREST, and pgBouncer orchestrated via Docker Compose with setup/teardown automation scripts.

## User Preferences
- ✓ Include sample 'todos' table for immediate testing
- ✓ Manual hosts file editing (safer, transparent)
- ✓ Bash scripts only (Git Bash/WSL compatible)

---

## Implementation Steps

### Phase 1: Project Structure & Configuration Files (Files: 20)

#### 1.1 Create Base Directory Structure
```
PeSquel/
├── traefik/dynamic/
├── postgres/init/
├── pgbouncer/
├── postgrest/
├── secrets/
├── postgres-data/
└── pgadmin-data/
```

#### 1.2 Create Git Configuration Files

**File: `.gitignore`**
- Exclude: `.env`, `secrets/*.txt`, `postgres-data/*`, `pgadmin-data/*`
- Keep: `.gitkeep` files for empty directories

**File: `.gitattributes`**
- Enforce LF line endings for: `*.sh`, `*.sql`, `*.conf`, `*.ini`, `*.yml`

#### 1.3 Create Traefik Configuration

**File: `traefik/traefik.yml`**
- Enable API dashboard (insecure mode for local MVP)
- Configure Docker provider with network "web"
- Configure file provider for dynamic config
- Set entrypoint on port 80
- Log level: INFO

**File: `traefik/dynamic/config.yml`**
- Define health check router and service
- Template for additional custom routes

#### 1.4 Create PostgreSQL Initialization Scripts

**File: `postgres/init/01-init-db.sql`**
- Create extensions: `uuid-ossp`, `pgcrypto`
- Set timezone to UTC
- Log initialization timestamp

**File: `postgres/init/02-create-schema.sql`**
- Create `api` schema
- Create sample `api.todos` table with:
  - `id` (UUID, primary key, auto-generated)
  - `title` (TEXT, not null)
  - `completed` (BOOLEAN, default false)
  - `created_at`, `updated_at` (TIMESTAMPTZ)
- Create `update_updated_at_column()` trigger function
- Enable Row-Level Security (RLS) on `api.todos`
- Create RLS policies for `api_anon` role (allow all operations for MVP)
- Grant schema usage and permissions

**File: `postgres/init/03-create-roles.sql`**
- Create `api_anon` role (NOLOGIN)
- Create `authenticator` role (LOGIN, NOINHERIT, password: 'authenticator_password')
- Grant `api_anon` to `authenticator`
- Grant schema and table permissions
- Set default privileges for future objects

#### 1.5 Create pgBouncer Configuration

**File: `pgbouncer/pgbouncer.ini`**
- Database: `pesequel_db = host=postgres port=5432 dbname=pesequel_db`
- Listen on: `0.0.0.0:6432`
- Auth type: `scram-sha-256` (fallback to md5 if needed)
- Pool mode: `transaction`
- Pool settings:
  - max_client_conn: 1000
  - default_pool_size: 20
  - min_pool_size: 5
  - reserve_pool_size: 5
- Timeouts: server_idle_timeout=600, server_lifetime=3600
- Logging: Enable connection/disconnection logs

**File: `pgbouncer/userlist.txt`**
- Placeholder (will be generated by setup.sh)
- Format: `"authenticator" "md5<hash>"`

#### 1.6 Create PostgREST Configuration

**File: `postgrest/postgrest.conf`**
- DB URI: `postgres://authenticator@pgbouncer:6432/pesequel_db`
- DB schema: `api`
- DB anon role: `api_anon`
- DB pool: 10 connections
- Server: `0.0.0.0:3000`
- OpenAPI proxy URI: `http://api.theddt.local`
- Disable prepared statements (required for transaction pooling)

#### 1.7 Create Environment Template

**File: `.env.example`**
- PostgreSQL: user, password, database, host, port
- pgAdmin: email, password
- PostgREST: JWT secret
- Authenticator password
- Domain configuration: theddt.local with subdomains
- pgBouncer settings

---

### Phase 2: Docker Compose Orchestration (File: 1)

**File: `docker-compose.yml`**

#### 2.1 Networks
- Create network `web` (bridge driver)

#### 2.2 Volumes
- `postgres_data`: Bind mount to `./postgres-data`
- `pgadmin_data`: Named volume

#### 2.3 Secrets
- `postgres_password`, `postgres_user`, `postgres_db`
- `pgadmin_email`, `pgadmin_password`
- `jwt_secret`
- All loaded from `./secrets/*.txt`

#### 2.4 Services

**Service: traefik**
- Image: `traefik:v3.2`
- Ports: 80 (HTTP), 8080 (dashboard)
- Volumes: Docker socket, config files
- Labels: Self-registration for dashboard at `traefik.theddt.local`
- Command args: Enable API, Docker provider, file provider

**Service: postgres**
- Image: `postgres:17-alpine`
- Port: 5432 (exposed for direct access)
- Environment: Use `*_FILE` variables for secrets
- Volumes: Data persistence + init scripts
- Health check: `pg_isready` command
- Secrets: postgres_user, postgres_password, postgres_db

**Service: pgbouncer**
- Image: `edoburu/pgbouncer:1.23.1`
- Environment: Connection string, pool settings
- Volumes: pgbouncer.ini, userlist.txt
- Depends on: postgres (healthy)
- Health check: `pg_isready -p 6432`

**Service: postgrest**
- Image: `postgrest/postgrest:v12.2.3`
- Port: 3000 (exposed for direct access)
- Environment: DB URI, schema, anon role, JWT secret file
- Depends on: pgbouncer (healthy)
- Traefik labels: Route `api.theddt.local` to port 3000

**Service: pgadmin**
- Image: `dpage/pgadmin4:latest`
- Environment: Email/password from secrets, server mode enabled
- Volumes: pgadmin_data for persistence
- Depends on: postgres (healthy)
- Traefik labels: Route `pgadmin.theddt.local` to port 80

---

### Phase 3: Automation Scripts (Files: 2)

#### 3.1 Setup Script

**File: `setup.sh`**

**Functionality:**
1. **Pre-flight checks**
   - Verify Docker is running (`docker info`)
   - Verify Docker Compose available (`docker compose version`)
   - Exit with error if checks fail

2. **Directory creation**
   - Create `secrets/`, `postgres-data/`, `pgadmin-data/`, `traefik/dynamic/`
   - Create `.gitkeep` files

3. **Secret generation** (skip if exists)
   - `postgres_user.txt`: "pesequel_user"
   - `postgres_password.txt`: Random 32-char base64 (`openssl rand -base64 32`)
   - `postgres_db.txt`: "pesequel_db"
   - `pgadmin_email.txt`: "admin@theddt.local"
   - `pgadmin_password.txt`: Random 32-char base64
   - `jwt_secret.txt`: Random 64-char base64

4. **Set permissions**
   - `chmod 600 secrets/*.txt`

5. **Generate pgBouncer userlist**
   - Create MD5 hash: `echo -n "passwordusername" | md5sum`
   - Write to `pgbouncer/userlist.txt`

6. **DNS configuration prompt**
   - Display hosts file entries needed:
     ```
     127.0.0.1 theddt.local
     127.0.0.1 api.theddt.local
     127.0.0.1 pgadmin.theddt.local
     127.0.0.1 traefik.theddt.local
     ```
   - Instructions for Windows: `C:\Windows\System32\drivers\etc\hosts`
   - Pause for user confirmation (manual edit)

7. **Docker network creation**
   - Create network `web` if not exists

8. **Service deployment**
   - Pull images: `docker compose pull`
   - Start services: `docker compose up -d`
   - Wait 10 seconds for startup

9. **Status display**
   - Show service status: `docker compose ps`
   - Display access URLs
   - Display credentials (read from secrets)
   - Show test commands

**Output formatting:**
- Color codes: Green (✓), Yellow (⚠), Red (✗)
- Clear section headers
- Helpful next steps

#### 3.2 Teardown Script

**File: `teardown.sh`**

**Functionality:**
1. **Confirmation prompt**
   - Warn about data removal
   - Require 'y/Y' to proceed

2. **Stop containers**
   - `docker compose down`

3. **Optional volume removal** (prompt user)
   - `docker compose down -v`
   - Delete `postgres-data/*` and `pgadmin-data/*`

4. **Optional network removal** (prompt user)
   - `docker network rm web`

5. **Optional secrets removal** (prompt user)
   - Delete `secrets/*.txt`

6. **Completion message**
   - Display cleanup summary
   - Suggest `./setup.sh` to start fresh

**Output formatting:**
- Same color scheme as setup.sh
- Interactive prompts for each destructive action

---

### Phase 4: Documentation (Files: 1)

**File: `README.md`**

**Sections:**
1. **Project Overview**
   - Brief description of the stack
   - ASCII architecture diagram

2. **Services List**
   - Table with service, role, hostname, port

3. **Prerequisites**
   - Docker Desktop for Windows (WSL 2 backend)
   - Git Bash or WSL
   - Administrator access

4. **Quick Start**
   - Clone/navigate to directory
   - Run `bash setup.sh`
   - Access service URLs

5. **Testing**
   - cURL examples for CRUD operations
   - OpenAPI documentation link

6. **Configuration**
   - Environment variables
   - Secrets location
   - Database schema customization

7. **Security**
   - RLS implementation
   - Database roles
   - Docker secrets
   - JWT authentication

8. **Troubleshooting**
   - Services not accessible → Check Docker, hosts file, logs
   - Database connection errors → Check health, pgBouncer logs
   - Permission errors → Verify secret permissions

9. **Cleanup**
   - Run `bash teardown.sh`

10. **License**
    - MIT (or as specified)

---

## Critical Files Summary

| File | Purpose | Key Details |
|------|---------|-------------|
| `docker-compose.yml` | Service orchestration | 5 services, network, volumes, secrets |
| `setup.sh` | Automation script | Secret generation, DNS prompt, deployment |
| `postgres/init/02-create-schema.sql` | Database schema | API schema, todos table, RLS policies |
| `traefik/traefik.yml` | Reverse proxy config | Docker provider, routing rules |
| `pgbouncer/pgbouncer.ini` | Connection pooling | Transaction mode, pool sizes |
| `.gitignore` | Version control | Exclude secrets and data |
| `README.md` | Documentation | Quick start, testing, troubleshooting |

---

## Implementation Order

1. **Structure** (5 min)
   - Create directories
   - Create `.gitignore`, `.gitattributes`

2. **Traefik** (10 min)
   - Create `traefik/traefik.yml`
   - Create `traefik/dynamic/config.yml`

3. **PostgreSQL** (15 min)
   - Create `postgres/init/01-init-db.sql`
   - Create `postgres/init/02-create-schema.sql`
   - Create `postgres/init/03-create-roles.sql`

4. **pgBouncer** (5 min)
   - Create `pgbouncer/pgbouncer.ini`
   - Create placeholder `pgbouncer/userlist.txt`

5. **PostgREST** (5 min)
   - Create `postgrest/postgrest.conf`

6. **Environment** (5 min)
   - Create `.env.example`

7. **Docker Compose** (20 min)
   - Create complete `docker-compose.yml`
   - Define all services with proper dependencies

8. **Automation** (25 min)
   - Create `setup.sh` with all checks and generation logic
   - Create `teardown.sh` with interactive prompts

9. **Documentation** (15 min)
   - Create `README.md` with complete guide

10. **Testing** (20 min)
    - Run `bash setup.sh`
    - Update hosts file manually
    - Verify all services accessible
    - Test API with cURL commands
    - Test pgAdmin connectivity
    - Run `bash teardown.sh`

**Total estimated time: ~2 hours**

---

## Post-Implementation Validation

### Service Accessibility
- [ ] Traefik dashboard: http://traefik.theddt.local
- [ ] PostgREST API: http://api.theddt.local
- [ ] pgAdmin UI: http://pgadmin.theddt.local
- [ ] PostgreSQL: Direct connection on localhost:5432

### Functional Testing
- [ ] Create todo: `POST /todos`
- [ ] List todos: `GET /todos`
- [ ] Update todo: `PATCH /todos?id=eq.<uuid>`
- [ ] Delete todo: `DELETE /todos?id=eq.<uuid>`
- [ ] OpenAPI spec: `GET /` returns JSON schema

### Security Verification
- [ ] No hardcoded credentials in `docker-compose.yml`
- [ ] All secrets in `./secrets/` with 600 permissions
- [ ] RLS enabled on `api.todos`
- [ ] PostgreSQL roles created correctly
- [ ] JWT secret generated (64 chars)

### Database Connectivity
- [ ] pgAdmin can connect to postgres via container name
- [ ] PostgREST can connect via pgBouncer
- [ ] pgBouncer can connect to PostgreSQL
- [ ] Health checks passing for all services

---

## Windows-Specific Considerations

### Line Endings
- `.gitattributes` enforces LF for scripts
- Git config: `git config --global core.autocrlf input`

### Hosts File
- Location: `C:\Windows\System32\drivers\etc\hosts`
- Requires administrator privileges
- Manual edit (safer than automation)

### Script Execution
- Use Git Bash: `bash setup.sh`
- Or WSL: `./setup.sh`

### Docker Desktop
- Ensure WSL 2 backend enabled
- File sharing: Add project directory to Docker Desktop settings
- Port conflicts: Check if ports 80, 5432, 3000 available

### Volume Performance
- Bind mounts slower than named volumes on Windows
- For best performance, store project in WSL filesystem
- Or use named volumes for postgres_data

---

## Security Implementation Details

### Row-Level Security (RLS)
```sql
-- Enable on table
ALTER TABLE api.todos ENABLE ROW LEVEL SECURITY;

-- Policy for anonymous read
CREATE POLICY "Allow anonymous read access" ON api.todos
  FOR SELECT TO api_anon USING (true);
```

### Database Roles
- **postgres**: Superuser (admin only)
- **authenticator**: PostgREST connection role (NOINHERIT)
- **api_anon**: Anonymous requests (limited permissions)

### Docker Secrets
- Mounted at `/run/secrets/<name>` in containers
- Read-only filesystem mount
- Not visible in `docker inspect`
- File permissions: 600 (owner read/write only)

### JWT Authentication (Future)
- PostgREST validates JWT tokens
- Claims map to PostgreSQL roles
- Minimum 32-character secret required
- Algorithm: HS256/HS384/HS512

---

## Troubleshooting Guide

### Issue: Services not starting
**Solution:**
1. Check Docker Desktop running
2. Check logs: `docker compose logs -f`
3. Check disk space: `docker system df`

### Issue: Can't access services via domain
**Solution:**
1. Verify hosts file entries
2. Ping domains: `ping theddt.local`
3. Check Traefik routing: http://traefik.theddt.local

### Issue: PostgreSQL init scripts not running
**Solution:**
1. Delete `postgres-data/*`
2. Run `docker compose down -v`
3. Run `setup.sh` again

### Issue: pgBouncer authentication failed
**Solution:**
1. Check `pgbouncer/userlist.txt` format
2. Verify password hash matches
3. Check pgBouncer logs: `docker compose logs pgbouncer`

### Issue: PostgREST can't connect
**Solution:**
1. Verify pgBouncer is healthy
2. Check prepared statements disabled: `PGRST_DB_PREPARED_STATEMENTS=false`
3. Check authenticator role exists in database

---

## Next Steps After MVP

1. **Add JWT authentication** - User login, token generation
2. **Extend database schema** - Application-specific tables
3. **Add migrations** - Use Flyway or sqitch for schema versioning
4. **Enable HTTPS** - Let's Encrypt with Traefik
5. **Add monitoring** - Prometheus + Grafana
6. **Configure backups** - Automated PostgreSQL backups
7. **CI/CD pipeline** - Automated testing and deployment
8. **Production hardening** - Rate limiting, CORS, security headers

---

## File Count

**Total files to create: 24**

### Configuration: 14 files
- `.gitignore`, `.gitattributes`
- `traefik/traefik.yml`, `traefik/dynamic/config.yml`
- `postgres/init/01-init-db.sql`, `postgres/init/02-create-schema.sql`, `postgres/init/03-create-roles.sql`
- `pgbouncer/pgbouncer.ini`, `pgbouncer/userlist.txt`
- `postgrest/postgrest.conf`
- `.env.example`
- `docker-compose.yml`

### Scripts: 2 files
- `setup.sh`
- `teardown.sh`

### Documentation: 1 file
- `README.md`

### Placeholder files: 7 files
- `secrets/.gitkeep`
- `postgres-data/.gitkeep`
- `pgadmin-data/.gitkeep`
- `traefik/dynamic/.gitkeep`
- `postgres/init/.gitkeep`
- `pgbouncer/.gitkeep`
- `postgrest/.gitkeep`

---

## Success Criteria

✓ All 5 services running and healthy
✓ All domains accessible via browser
✓ API responds to CRUD operations
✓ Database persists data across restarts
✓ Secrets properly secured (no hardcoded credentials)
✓ Documentation complete and accurate
✓ Setup script fully automated (except hosts file)
✓ Teardown script cleans up completely
✓ No errors in service logs
✓ RLS policies active and enforced
