server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://grafanastack.theddt.local:3100/loki/api/v1/push

scrape_configs:
  - job_name: postgres
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: 'db-stack[_-]postgres[_-].*'
        target_label: __tmp_docker_container_name
      - source_labels: ['__tmp_docker_container_name']
        target_label: container
      - source_labels: ['__meta_docker_container_log_stream']
        target_label: stream
    pipeline_stages:
      - match:
          selector: '{container=~".*postgres.*"}'
          stages:
            - regex:
                expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3}) \[(?P<pid>\d+)\] (?P<user>\w+)@(?P<database>\w+) (?P<level>\w+):\s*(?P<message>.*)'
            - labels:
                timestamp:
                pid:
                user: 
                database:
                level:
            - match:
                selector: '{container=~".*postgres.*"} |~ "AUDIT:"'
                stages:
                  - labels:
                      audit: "true"
    static_configs:
      - targets:
          - localhost
        labels:
          job: postgres
          service: postgresql
          stack: db-stack
          __path__: /var/lib/docker/containers/*/*-json.log

  - job_name: pgbouncer
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: 'db-stack[_-]pgbouncer[_-].*'
        target_label: __tmp_docker_container_name
      - source_labels: ['__tmp_docker_container_name']
        target_label: container
    static_configs:
      - targets:
          - localhost
        labels:
          job: pgbouncer
          service: pgbouncer
          stack: db-stack
          __path__: /var/lib/docker/containers/*/*-json.log

  - job_name: todo-api
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: 'db-stack[_-]todo-api[_-].*'
        target_label: __tmp_docker_container_name
      - source_labels: ['__tmp_docker_container_name']
        target_label: container
      - source_labels: ['__meta_docker_container_log_stream']
        target_label: stream
    pipeline_stages:
      - match:
          selector: '{container=~".*todo-api.*"}'
          stages:
            - regex:
                expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3}) - (?P<logger>\w+) - (?P<level>\w+) - (?P<message>.*)'
            - labels:
                timestamp:
                logger:
                level:
            - match:
                selector: '{container=~".*todo-api.*"} |~ "(GET|POST|PUT|DELETE)"'
                stages:
                  - labels:
                      request_type: "api_request"
            - match:
                selector: '{container=~".*todo-api.*"} |~ "(ERROR|WARNING)"'
                stages:
                  - labels:
                      alert_level: "warning"
    static_configs:
      - targets:
          - localhost
        labels:
          job: todo-api
          service: fastapi
          stack: db-stack
          __path__: /var/lib/docker/containers/*/*-json.log
